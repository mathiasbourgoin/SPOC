; Test helper library with optional backend support
; Uses (select ...) in libraries to conditionally include GPU backends
;
; Environment variables to force-disable backends for testing:
;   SPOC_DISABLE_CUDA=1    - Disable CUDA backend
;   SPOC_DISABLE_OPENCL=1  - Disable OpenCL backend
;   SPOC_DISABLE_VULKAN=1  - Disable Vulkan backend
;   SPOC_DISABLE_METAL=1   - Disable Metal backend
;   SPOC_DISABLE_GPU=1     - Disable all GPU backends (CUDA, OpenCL, Vulkan, Metal)

(library
 (name registered_defs)
 (modules registered_defs)
 (libraries sarek sarek_stdlib spoc_core)
 (preprocess
  (pps sarek_ppx)))

(library
 (name test_helpers)
 (modules
  test_helpers
  Benchmarks
  backend_loader
  backend_cuda
  backend_opencl
  backend_vulkan
  backend_metal)
 (libraries
  spoc_core
  ; Always-available backends
  sarek_native
  sarek_interpreter
  ; Optionally include GPU backends if available and not disabled
  (select
   backend_cuda.ml
   from
   (sarek_cuda -> backend_cuda.available.ml)
   (-> backend_cuda.unavailable.ml))
  (select
   backend_opencl.ml
   from
   (sarek_opencl -> backend_opencl.available.ml)
   (-> backend_opencl.unavailable.ml))
  (select
   backend_vulkan.ml
   from
   (sarek_vulkan -> backend_vulkan.available.ml)
   (-> backend_vulkan.unavailable.ml))
  (select
   backend_metal.ml
   from
   (sarek_metal -> backend_metal.available.ml)
   (-> backend_metal.unavailable.ml))
  unix))

(executable
 (name test_vector_add)
 (modules test_vector_add)
 (libraries sarek sarek.stdlib sarek.visibility sarek.ppx.lib registered_defs spoc_core test_helpers unix)
 (preprocess (pps sarek_ppx))
 (flags (:standard -w -32-33-34-69)))

(executable
 (name test_module_const)
 (modules test_module_const)
 (libraries sarek sarek.stdlib sarek.float64 sarek_geometry sarek.visibility sarek.ppx.lib registered_defs spoc_core test_helpers unix)
 (preprocess (pps sarek_ppx))
 (flags (:standard -w -32-33-34-69)))

(executable
 (name test_ktype_record)
 (modules test_ktype_record)
 (libraries sarek sarek.stdlib sarek.visibility sarek.ppx.lib registered_defs spoc_core test_helpers unix)
 (preprocess (pps sarek_ppx))
 (flags (:standard -w -32-33-34-69)))

(executable
 (name test_klet_fun)
 (modules test_klet_fun)
 (libraries sarek sarek.stdlib sarek.visibility sarek.ppx.lib registered_defs spoc_core test_helpers unix)
 (preprocess (pps sarek_ppx))
 (flags (:standard -w -32-33-34-69)))

(executable
 (name test_klet_variant)
 (modules test_klet_variant)
 (libraries sarek sarek.stdlib sarek.visibility sarek.ppx.lib registered_defs spoc_core test_helpers unix)
 (preprocess (pps sarek_ppx))
 (flags (:standard -w -32-33-34-69)))

(executable
 (name test_ktype_helper)
 (modules test_ktype_helper)
 (libraries sarek sarek.stdlib sarek.visibility sarek.ppx.lib registered_defs spoc_core test_helpers unix)
 (preprocess (pps sarek_ppx))
 (flags (:standard -w -32-33-34-69)))

(executable
 (name test_nbody_ppx)
 (modules test_nbody_ppx)
 (libraries sarek sarek.stdlib sarek.visibility sarek.ppx.lib registered_defs spoc_core test_helpers unix)
 (preprocess (pps sarek_ppx))
 (flags (:standard -w -32-33-34-69)))

(executable
 (name test_ray_ppx)
 (modules test_ray_ppx)
 (libraries sarek sarek.stdlib sarek.visibility sarek.ppx.lib registered_defs spoc_core test_helpers unix)
 (preprocess (pps sarek_ppx))
 (flags (:standard -w -32-33-34-69)))

(executable
 (name test_registered_type)
 (modules test_registered_type)
 (libraries sarek sarek.stdlib sarek.visibility sarek.ppx.lib spoc_core test_helpers unix)
 (preprocess (pps sarek_ppx))
 (flags (:standard -w -32-33-34-69)))

(alias
 (name runtest)
 (deps
  test_vector_add.exe
  test_module_const.exe
  test_ktype_record.exe
  test_klet_fun.exe
  test_klet_variant.exe
  test_ktype_helper.exe
  test_nbody_ppx.exe
  test_ray_ppx.exe
  test_registered_type.exe
  test_registered_variant.exe
  test_cross_module_type.exe
  test_registered_const.exe
  test_visibility_private.exe
  test_convention.exe
  test_convention_kernel.exe
  test_pragma.exe
  test_barrier_converged.exe
  test_superstep.exe
  test_fusion_api.exe
  test_stencil.exe
  test_matrix_mul.exe
  test_reduce.exe
  test_complex_types.exe
  test_math_intrinsics.exe
  test_bitwise_ops.exe
  test_scan.exe
  test_transpose.exe
  test_sort.exe
  test_histogram.exe
  test_convolution.exe
  test_mandelbrot.exe
  test_polymorphism.exe))

(executable
 (name test_debug_native)
 (modules test_debug_native)
 (libraries sarek sarek_native sarek_stdlib spoc_core unix)
 (preprocess
  (pps sarek_ppx)))

; External kernel test - works with any available backend

(executable
 (name test_external_kernel)
 (modules test_external_kernel)
 (optional)
 (libraries sarek spoc_core test_helpers unix))
