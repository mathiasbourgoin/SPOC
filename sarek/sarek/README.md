# sarek/sarek - Sarek Runtime & Execution Layer

The `sarek/sarek` package provides the runtime execution infrastructure for Sarek GPU kernels. It bridges the Sarek IR (generated by the PPX) and backend implementations (CUDA, OpenCL, Vulkan, Native CPU, Interpreter).

## Quick Start Example

```ocaml
(* Define a simple vector addition kernel *)
let vector_add =
  [%kernel fun (a : int32 vector) (b : int32 vector) (c : int32 vector) ->
    let gid = Std.global_idx_x in
    c.(gid) <- a.(gid) + b.(gid)]

(* Execute on a device *)
let () =
  let dev = Device.get_default () in
  let n = 1024 in
  let a = Vector.create_int32 n in
  let b = Vector.create_int32 n in
  let c = Vector.create_int32 n in
  
  (* Fill with data... *)
  
  (* Run kernel: grid=(4,1,1), block=(256,1,1) *)
  Sarek.Execute.run vector_add ~device:dev
    ~block:(256, 1, 1) ~grid:(4, 1, 1)
    [Vec a; Vec b; Vec c]
```

## Architecture Overview

```
User Code ([%kernel ...])
         ↓
    Sarek PPX (generates Sarek IR)
         ↓
┌────────────────────────────────────┐
│   sarek/sarek (this package)      │
│                                    │
│  Execute.ml ← Main dispatcher      │
│  Sarek_ir_interp.ml ← Interpreter │
│  Sarek_cpu_runtime.ml ← Native    │
│  Sarek_fusion.ml ← Optimizer      │
└────────────────────────────────────┘
         ↓
  Backend Plugins (CUDA/OpenCL/etc)
```

## Core Modules

See the full documentation for detailed examples and API reference.

### Execute.ml - Unified Kernel Execution Dispatcher
### Sarek_cpu_runtime.ml - Native CPU Execution Runtime  
### Sarek_ir_interp.ml - CPU Interpreter for Sarek IR
### Sarek_fusion.ml - Kernel Fusion Optimizer
### Kirc_kernel.ml - Kernel Management

## Testing & Coverage

Current test coverage: 42.42% (79 tests)
- ✅ Sarek_cpu_runtime: 71.56% (28 tests)
- ✅ Sarek_ir_interp: 22.49% (23 tests)
- ✅ Execute: 26.07% (15 tests)

## See Also

- [FUSION.md](FUSION.md) - Kernel fusion documentation
- [BSP.md](BSP.md) - Bulk Synchronous Parallel model
- [../ppx/README.md](../ppx/README.md) - Sarek PPX compiler  
- [../../COVERAGE.md](../../COVERAGE.md) - Coverage infrastructure
