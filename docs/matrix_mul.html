<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link rel="icon" href="/Sarek/favicon.ico" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
    <script src="/Sarek/javascripts/process-rel-links.js" type="text/javascript"></script>
    <title>Sarek - Documentation</title>

    <link rel="stylesheet" href='/Sarek/stylesheets/modern.css'>
    <link rel="stylesheet" href='/Sarek/stylesheets/pygment_trac.css'>
    <style>
      /* Documentation specific tweaks to modern.css */
      .doc-wrapper {
        display: flex;
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 20px;
      }
      .sidebar {
        width: 250px;
        flex-shrink: 0;
        padding-right: 40px;
        border-right: 1px solid var(--border-color);
      }
      .doc-content {
        flex-grow: 1;
        padding-left: 40px;
        min-width: 0; /* Prevents overflow in flexbox */
      }
      .sidebar img {
        width: 100%;
        max-width: 200px;
        display: block;
        margin: 0 auto 20px;
      }
      .sidebar-nav {
        list-style: none;
        padding: 0;
      }
      .sidebar-nav li {
        margin-bottom: 10px;
      }
      .sidebar-nav a {
        font-weight: 600;
        color: var(--secondary-color);
      }
      @media (max-width: 768px) {
        .doc-wrapper { flex-direction: column; }
        .sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; margin-bottom: 40px; }
        .doc-content { padding-left: 0; }
      }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  </head>
  <body>
    
    <!-- Top Navigation Bar -->
    <nav class="navbar">
      <div class="container">
        <a href="/Sarek/" class="nav-brand">
          <img src="/Sarek/pres_resources/logo_sarek.png" alt="Sarek Logo">
          Sarek
        </a>
        <div class="nav-links">
          <a href="/Sarek/">Home</a>
          <a href="/Sarek/docs/getting_started.html">Getting Started</a>
          <a href="/Sarek/docs/concepts.html">Concepts</a>
          <a href="/Sarek/spoc_docs/index.html">API Docs</a>
          <a href="https://github.com/mathiasbourgoin/Sarek">GitHub</a>
          <button id="theme-toggle" title="Toggle Dark/Light Mode">
            <span>üåô</span>
          </button>
        </div>
      </div>
    </nav>

    <div class="doc-wrapper">
      <nav class="sidebar">
        <ul class="sidebar-nav">
          <li><strong>Overview</strong></li>
          <li><a href="/Sarek/docs/getting_started.html">Getting Started</a></li>
          <li><a href="/Sarek/docs/concepts.html">Concepts</a></li>
          <li><a href="/Sarek/docs/interactive.html">Interactive (Jupyter)</a></li>
          <li><a href="/Sarek/docs/binder.html">Try Online (Binder)</a></li>
          <li style="margin-top: 10px; margin-left: 10px;"><a href="/Sarek/docs/live_mandelbrot.html">‚ú® Live Mandelbrot</a></li>
          <li style="margin-left: 10px;"><a href="/Sarek/docs/live_transpiler.html">‚ú® Live Transpiler</a></li>
          <li><a href="/Sarek/docs/transpiler.html">Inspector</a></li>
          <li><a href="/Sarek/docs/architecture.html">Architecture</a></li>
          <li><a href="/Sarek/docs/backends.html">Backends</a></li>
          <li><a href="/Sarek/docs/faq.html">FAQ</a></li>
          
          <li style="margin-top: 20px;"><strong>Examples</strong></li>
          <li><a href="/Sarek/docs/vector_add.html">Vector Addition</a></li>
          <li><a href="/Sarek/docs/matrix_mul.html">Matrix Multiplication</a></li>
          <li><a href="/Sarek/docs/transpose.html">Matrix Transpose</a></li>
          <li><a href="/Sarek/docs/reduction.html">Parallel Reduction</a></li>
          <li><a href="/Sarek/docs/mandelbrot.html">Mandelbrot Set</a></li>
          
          <li style="margin-top: 20px;"><strong>Development</strong></li>
          <li><a href="/Sarek/docs/build_guide.html">Build Guide</a></li>
          <li><a href="/Sarek/docs/new_backend.html">Building a Backend</a></li>
          
          <li style="margin-top: 20px;"><strong>Resources</strong></li>
          <li><a href="/Sarek/spoc_docs/index.html">API Reference</a></li>
          <li><a href="/Sarek/docs/publications.html">Publications</a></li>
          <li><a href="/Sarek/docs/history.html">History</a></li>
        </ul>
      </nav>

      <main class="doc-content">
        <h1 id="matrix-multiplication">Matrix Multiplication</h1>

<p>Matrix multiplication is a fundamental operation in high-performance computing. This example demonstrates two approaches: a naive implementation and an optimized tiled implementation using shared memory.</p>

<h2 id="naive-implementation">Naive Implementation</h2>

<p>Each thread computes one element of the output matrix <code class="language-plaintext highlighter-rouge">C</code>. It reads a full row from <code class="language-plaintext highlighter-rouge">A</code> and a full column from <code class="language-plaintext highlighter-rouge">B</code> from global memory.</p>

<div class="language-ocaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">open</span> <span class="nc">Sarek</span>

<span class="k">let</span><span class="o">%</span><span class="n">kernel</span> <span class="n">matmul_naive</span> <span class="p">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">float32</span> <span class="n">vector</span><span class="p">)</span> <span class="p">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">float32</span> <span class="n">vector</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">float32</span> <span class="n">vector</span><span class="p">)</span>
                        <span class="p">(</span><span class="n">m</span> <span class="o">:</span> <span class="n">int32</span><span class="p">)</span> <span class="p">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">int32</span><span class="p">)</span> <span class="p">(</span><span class="n">k</span> <span class="o">:</span> <span class="n">int32</span><span class="p">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">row</span> <span class="o">=</span> <span class="n">get_global_id</span> <span class="mi">1</span> <span class="k">in</span> <span class="c">(* y-dimension *)</span>
  <span class="k">let</span> <span class="n">col</span> <span class="o">=</span> <span class="n">get_global_id</span> <span class="mi">0</span> <span class="k">in</span> <span class="c">(* x-dimension *)</span>
  
  <span class="k">if</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">m</span> <span class="o">&amp;&amp;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="k">then</span> <span class="k">begin</span>
    <span class="k">let</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="k">in</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">sum</span> <span class="o">:=</span> <span class="o">!</span><span class="n">sum</span> <span class="o">+.</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="p">((</span><span class="n">row</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">*.</span> <span class="n">b</span><span class="o">.</span><span class="p">((</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">col</span><span class="p">))</span>
    <span class="k">done</span><span class="p">;</span>
    <span class="n">c</span><span class="o">.</span><span class="p">((</span><span class="n">row</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">col</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="o">!</span><span class="n">sum</span>
  <span class="k">end</span>
</code></pre></div></div>

<h2 id="tiled-implementation-shared-memory">Tiled Implementation (Shared Memory)</h2>

<p>To reduce global memory accesses, we can load blocks (‚Äútiles‚Äù) of <code class="language-plaintext highlighter-rouge">A</code> and <code class="language-plaintext highlighter-rouge">B</code> into fast shared memory. All threads in a block cooperate to load the tiles, synchronize, and then compute a partial product.</p>

<div class="language-ocaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span><span class="o">%</span><span class="n">kernel</span> <span class="n">matmul_tiled</span> <span class="p">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">float32</span> <span class="n">vector</span><span class="p">)</span> <span class="p">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">float32</span> <span class="n">vector</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">float32</span> <span class="n">vector</span><span class="p">)</span>
                        <span class="p">(</span><span class="n">m</span> <span class="o">:</span> <span class="n">int32</span><span class="p">)</span> <span class="p">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">int32</span><span class="p">)</span> <span class="p">(</span><span class="n">k</span> <span class="o">:</span> <span class="n">int32</span><span class="p">)</span> <span class="o">=</span>
  <span class="c">(* Allocate shared memory for tiles *)</span>
  <span class="k">let</span><span class="o">%</span><span class="n">shared</span> <span class="n">tile_a</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">create</span> <span class="nc">Float32</span> <span class="mi">256</span> <span class="k">in</span> <span class="c">(* 16x16 *)</span>
  <span class="k">let</span><span class="o">%</span><span class="n">shared</span> <span class="n">tile_b</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">create</span> <span class="nc">Float32</span> <span class="mi">256</span> <span class="k">in</span>
  
  <span class="k">let</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">thread_idx_x</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">thread_idx_y</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">row</span> <span class="o">=</span> <span class="n">ty</span> <span class="o">+</span> <span class="p">(</span><span class="n">block_dim_y</span> <span class="o">*</span> <span class="n">block_idx_y</span><span class="p">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">col</span> <span class="o">=</span> <span class="n">tx</span> <span class="o">+</span> <span class="p">(</span><span class="n">block_dim_x</span> <span class="o">*</span> <span class="n">block_idx_x</span><span class="p">)</span> <span class="k">in</span>
  
  <span class="k">let</span> <span class="n">tile_size</span> <span class="o">=</span> <span class="mi">16</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">num_tiles</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">tile_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">tile_size</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="k">in</span>
  
  <span class="k">for</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">num_tiles</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
    <span class="c">(* Collaborative load into shared memory *)</span>
    <span class="k">let</span><span class="o">%</span><span class="n">superstep</span> <span class="n">load</span> <span class="o">=</span>
      <span class="k">let</span> <span class="n">a_col</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">tile_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">tx</span> <span class="k">in</span>
      <span class="k">if</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">m</span> <span class="o">&amp;&amp;</span> <span class="n">a_col</span> <span class="o">&lt;</span> <span class="n">k</span> <span class="k">then</span>
        <span class="n">tile_a</span><span class="o">.</span><span class="p">((</span><span class="n">ty</span> <span class="o">*</span> <span class="n">tile_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">tx</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">a</span><span class="o">.</span><span class="p">((</span><span class="n">row</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">a_col</span><span class="p">)</span>
      <span class="k">else</span> 
        <span class="n">tile_a</span><span class="o">.</span><span class="p">((</span><span class="n">ty</span> <span class="o">*</span> <span class="n">tile_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">tx</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="p">;</span>
        
      <span class="k">let</span> <span class="n">b_row</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">tile_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">ty</span> <span class="k">in</span>
      <span class="k">if</span> <span class="n">b_row</span> <span class="o">&lt;</span> <span class="n">k</span> <span class="o">&amp;&amp;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="k">then</span>
        <span class="n">tile_b</span><span class="o">.</span><span class="p">((</span><span class="n">ty</span> <span class="o">*</span> <span class="n">tile_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">tx</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">b</span><span class="o">.</span><span class="p">((</span><span class="n">b_row</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">col</span><span class="p">)</span>
      <span class="k">else</span> 
        <span class="n">tile_b</span><span class="o">.</span><span class="p">((</span><span class="n">ty</span> <span class="o">*</span> <span class="n">tile_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">tx</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span>
    <span class="k">in</span>
    
    <span class="c">(* Compute partial product for this tile *)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">tile_size</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">sum</span> <span class="o">:=</span> <span class="o">!</span><span class="n">sum</span> <span class="o">+.</span> <span class="p">(</span><span class="n">tile_a</span><span class="o">.</span><span class="p">((</span><span class="n">ty</span> <span class="o">*</span> <span class="n">tile_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">*.</span> <span class="n">tile_b</span><span class="o">.</span><span class="p">((</span><span class="n">i</span> <span class="o">*</span> <span class="n">tile_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">tx</span><span class="p">))</span>
    <span class="k">done</span>
  <span class="k">done</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">m</span> <span class="o">&amp;&amp;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="k">then</span> 
    <span class="n">c</span><span class="o">.</span><span class="p">((</span><span class="n">row</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">col</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="o">!</span><span class="n">sum</span>
</code></pre></div></div>

<h2 id="host-code">Host Code</h2>

<div class="language-ocaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">run_matmul</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">m</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">,</span> <span class="mi">1024</span><span class="o">,</span> <span class="mi">1024</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">device</span> <span class="o">=</span> <span class="nn">Device</span><span class="p">.</span><span class="n">get_default</span> <span class="bp">()</span> <span class="k">in</span>
  
  <span class="c">(* 16x16 thread blocks *)</span>
  <span class="k">let</span> <span class="n">block</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="o">,</span> <span class="mi">16</span><span class="o">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">grid</span> <span class="o">=</span> <span class="p">((</span><span class="n">n</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span><span class="o">/</span><span class="mi">16</span><span class="o">,</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span><span class="o">/</span><span class="mi">16</span><span class="o">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">in</span>
  
  <span class="nn">Execute</span><span class="p">.</span><span class="n">run</span> <span class="n">matmul_tiled</span> 
    <span class="o">~</span><span class="n">device</span> <span class="o">~</span><span class="n">grid</span> <span class="o">~</span><span class="n">block</span> 
    <span class="p">[</span><span class="nc">Vec</span> <span class="n">a</span><span class="p">;</span> <span class="nc">Vec</span> <span class="n">b</span><span class="p">;</span> <span class="nc">Vec</span> <span class="n">c</span><span class="p">;</span> <span class="nc">Int32</span> <span class="n">m</span><span class="p">;</span> <span class="nc">Int32</span> <span class="n">n</span><span class="p">;</span> <span class="nc">Int32</span> <span class="n">k</span><span class="p">]</span>
</code></pre></div></div>

      </main>
    </div>

    <footer>
      <div class="container">
        <p>Sarek is maintained by <a href="https://github.com/mathiasbourgoin">mathiasbourgoin</a></p>
      </div>
    </footer>

    <script src="/Sarek/javascripts/scale.fix.js"></script>
    <script src="/Sarek/javascripts/copy-code.js"></script>
    <script src="/Sarek/javascripts/theme-toggle.js"></script>
    <script src="/Sarek/javascripts/syntax-sarek.js"></script>
    <script src="/Sarek/javascripts/code-tabs.js"></script>
    <script src="/Sarek/javascripts/init-mermaid.js"></script>
    
    <!-- Thebe for Live Execution -->
    <link rel="stylesheet" href="https://unpkg.com/thebe@latest/lib/index.css">
    <script src="https://unpkg.com/thebe@latest/lib/index.js"></script>
    <script>
      window.bootstrapThebe = function() {
        const btn = document.getElementById('thebe-activate');
        btn.innerText = "‚è≥ Connecting to Binder...";
        btn.disabled = true;

        thebe.bootstrap({
          binderOptions: {
            repo: "mathiasbourgoin/Sarek",
            ref: "1d135f38f6d475740126a0d5ea77e9317b825226",
          },
          kernelOptions: {
            name: "ocaml-jupyter",
          },
          selector: "[data-executable]",
          requestKernel: true,
        }).then(kernel => {
            btn.innerText = "‚úÖ Live Environment Active";
            console.log("Thebe kernel initialized:", kernel);
        }).catch(err => {
            btn.innerText = "‚ùå Connection Failed";
            console.error("Thebe error:", err);
            btn.disabled = false;
        });
      }
    </script>

    <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
      
      // Transform code blocks to divs
      if (window.transformMermaidBlocks) {
        window.transformMermaidBlocks();
      }

      // Initialize and render
      mermaid.initialize({ 
        startOnLoad: false, 
        theme: 'neutral',
        securityLevel: 'loose'
      });
      await mermaid.run();
    </script>
  </body>
</html>
