<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link rel="icon" href="/Sarek/preview/pr-108/favicon.ico" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
    <script src="/Sarek/preview/pr-108/javascripts/process-rel-links.js" type="text/javascript"></script>
    <title>Building a New Backend - Sarek</title>
    
    <link rel="stylesheet" href='/Sarek/preview/pr-108/stylesheets/modern.css'>
    <link rel="stylesheet" href='/Sarek/preview/pr-108/stylesheets/pygment_trac.css'>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  </head>
  <body>

    <!-- Top Navigation Bar -->
    <nav class="navbar">
      <div class="container">
        <a href="/Sarek/preview/pr-108/" class="nav-brand">
          <img src="/Sarek/preview/pr-108/pres_resources/logo_sarek.png" alt="Sarek Logo">
          Sarek
        </a>
        <div class="nav-links">
          <a href="/Sarek/preview/pr-108/">Home</a>
          <a href="/Sarek/preview/pr-108/docs/getting_started.html">Getting Started</a>
          <a href="/Sarek/preview/pr-108/benchmarks/">Benchmarks</a>
          <a href="/Sarek/preview/pr-108/examples/">Examples</a>
          <div class="nav-dropdown">
            <a href="#" class="dropdown-toggle">Docs ‚ñæ</a>
            <div class="dropdown-menu">
              <a href="/Sarek/preview/pr-108/docs/concepts.html">Concepts</a>
              <a href="/Sarek/preview/pr-108/docs/architecture.html">Architecture</a>
              <a href="/Sarek/preview/pr-108/docs/backends.html">Backends</a>
              <a href="/Sarek/preview/pr-108/docs/build_guide.html">Build Guide</a>
              <a href="/Sarek/preview/pr-108/docs/faq.html">FAQ</a>
              <a href="/Sarek/preview/pr-108/docs/publications.html">Publications</a>
            </div>
          </div>
          <a href="/Sarek/preview/pr-108/spoc_docs/index.html">API</a>
          <a href="https://github.com/mathiasbourgoin/Sarek">GitHub</a>
          <button id="theme-toggle" title="Toggle Dark/Light Mode">
            <span>üåô</span>
          </button>
        </div>
      </div>
    </nav>

    <main class="main-content">
      <div class="container">
        <h1 id="building-a-new-backend-plugin">Building a New Backend Plugin</h1>

<p>Sarek is designed to be extensible. Adding a new target (e.g., WebGPU, HIP, or a custom FPGA backend) involves implementing the standard <code class="language-plaintext highlighter-rouge">BACKEND</code> signature.</p>

<h2 id="1-choosing-an-execution-model">1. Choosing an Execution Model</h2>

<p>Backends in Sarek follow one of two primary execution models:</p>

<ul>
  <li><strong>JIT (Just-In-Time)</strong>: The backend generates source code (CUDA C, OpenCL C, GLSL) from Sarek IR at runtime, compiles it using a GPU driver, and launches the binary.</li>
  <li><strong>Direct</strong>: The backend executes pre-compiled OCaml functions. This is how the <strong>Native CPU</strong> backend works, using OCaml 5 Domains for parallelism without any runtime compilation.</li>
</ul>

<p>Your implementation must specify this in the <code class="language-plaintext highlighter-rouge">execution_model</code> field of the signature.</p>

<h2 id="2-implementing-intrinsics">2. Implementing Intrinsics</h2>

<p><strong>Intrinsics</strong> are the bridge between Sarek‚Äôs high-level OCaml syntax and backend-specific hardware features (like thread IDs, barriers, or specialized math functions).</p>

<h3 id="the-intrinsic-registry">The Intrinsic Registry</h3>
<p>Every backend provides an <code class="language-plaintext highlighter-rouge">INTRINSIC_REGISTRY</code>. This is where you map Sarek names to your backend‚Äôs implementation.</p>

<p>For a <strong>JIT backend</strong>, an intrinsic implementation is usually a code-generation function:</p>
<div class="language-ocaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">(* Mapping Sarek's 'barrier()' to OpenCL's 'barrier(CLK_LOCAL_MEM_FENCE)' *)</span>
<span class="nn">Registry</span><span class="p">.</span><span class="n">register</span> <span class="s2">"barrier"</span> <span class="p">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="s2">"barrier(CLK_LOCAL_MEM_FENCE);"</span><span class="p">)</span>
</code></pre></div></div>

<p>For a <strong>Direct backend</strong> (Native), it is an actual OCaml function:</p>
<div class="language-ocaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">(* Mapping thread_idx_x to a function that reads the current domain state *)</span>
<span class="nn">Registry</span><span class="p">.</span><span class="n">register</span> <span class="s2">"thread_idx_x"</span> <span class="p">(</span><span class="k">fun</span> <span class="n">state</span> <span class="o">-&gt;</span> <span class="n">state</span><span class="o">.</span><span class="n">tid_x</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="3-handling-native-code-blocks">3. Handling Native Code Blocks</h2>

<p>Sarek allows users to embed backend-specific code directly using <code class="language-plaintext highlighter-rouge">[%native.backend "..."]</code>.</p>

<p>If you are building a backend named <code class="language-plaintext highlighter-rouge">mygpu</code>, you must ensure your code generator looks for <code class="language-plaintext highlighter-rouge">SNative ("mygpu", code)</code> nodes in the IR. This allows power users to bypass the compiler and use hand-optimized assembly or specialized hardware features.</p>

<h2 id="4-the-backend-signature-modules">4. The <code class="language-plaintext highlighter-rouge">BACKEND</code> Signature Modules</h2>

<p>Your plugin must implement several core modules:</p>

<ul>
  <li><strong>Device</strong>: Logic to enumerate hardware and query <code class="language-plaintext highlighter-rouge">capabilities</code> (max threads, shared memory size, FP64 support).</li>
  <li><strong>Memory</strong>: Functions to allocate device buffers and transfer data. You should support:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">host_to_device</code> / <code class="language-plaintext highlighter-rouge">device_to_host</code></li>
      <li><code class="language-plaintext highlighter-rouge">alloc_zero_copy</code>: (Optional) for devices that share memory with the CPU.</li>
    </ul>
  </li>
  <li><strong>Kernel</strong>: Handles the lifecycle of a kernel:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">compile</code>: Takes a source string and produces a runnable handle.</li>
      <li><code class="language-plaintext highlighter-rouge">launch</code>: Marshals <code class="language-plaintext highlighter-rouge">exec_arg</code> values into the hardware‚Äôs expected format.</li>
    </ul>
  </li>
</ul>

<h2 id="5-plugin-registration">5. Plugin Registration</h2>

<p>Register your backend with a <code class="language-plaintext highlighter-rouge">priority</code>. SPOC uses this to automatically select the best available device (e.g., CUDA is usually priority 100, while Native CPU is 50).</p>

<div class="language-ocaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Spoc_framework</span><span class="p">.</span><span class="nn">Framework_registry</span><span class="p">.</span><span class="n">register_backend</span>
    <span class="o">~</span><span class="n">priority</span><span class="o">:</span><span class="mi">80</span> 
    <span class="p">(</span><span class="k">module</span> <span class="nc">MyNewBackend</span> <span class="o">:</span> <span class="nn">Spoc_framework</span><span class="p">.</span><span class="nn">Framework_sig</span><span class="p">.</span><span class="nc">BACKEND</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="6-testing-your-backend">6. Testing Your Backend</h2>

<ol>
  <li><strong>IR Tests</strong>: Ensure your translator produces valid source code for all Sarek IR nodes (loops, matches, record assignments).</li>
  <li><strong>Intrinsic Tests</strong>: Verify that all standard Sarek intrinsics are correctly mapped.</li>
  <li><strong>E2E Tests</strong>: Run the suite in <code class="language-plaintext highlighter-rouge">sarek/tests/e2e</code>. A backend is considered ‚Äústable‚Äù if it passes the <code class="language-plaintext highlighter-rouge">test_vector_add</code>, <code class="language-plaintext highlighter-rouge">test_reduce</code>, and <code class="language-plaintext highlighter-rouge">test_matmul</code> benchmarks.</li>
</ol>

      </div>
    </main>

    <footer>
      <div class="container">
        <p>Sarek is maintained by <a href="https://github.com/mathiasbourgoin">mathiasbourgoin</a></p>
        <p>Hosted on GitHub Pages</p>
      </div>
    </footer>

    <script src="/Sarek/preview/pr-108/javascripts/scale.fix.js"></script>
    <script src="/Sarek/preview/pr-108/javascripts/copy-code.js"></script>
    <script src="/Sarek/preview/pr-108/javascripts/theme-toggle.js"></script>
    <script src="/Sarek/preview/pr-108/javascripts/syntax-sarek.js"></script>
  </body>
</html>
