<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link rel="icon" href="/Sarek/preview/pr-78/favicon.ico" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
    <script src="/Sarek/preview/pr-78/javascripts/process-rel-links.js" type="text/javascript"></script>
    <title>Sarek Transpiler Inspector - Sarek</title>
    
    <link rel="stylesheet" href='/Sarek/preview/pr-78/stylesheets/modern.css'>
    <link rel="stylesheet" href='/Sarek/preview/pr-78/stylesheets/pygment_trac.css'>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  </head>
  <body>

    <!-- Top Navigation Bar -->
    <nav class="navbar">
      <div class="container">
        <a href="/Sarek/preview/pr-78/" class="nav-brand">
          <img src="/Sarek/preview/pr-78/pres_resources/logo_sarek.png" alt="Sarek Logo">
          Sarek
        </a>
        <div class="nav-links">
          <a href="/Sarek/preview/pr-78/">Home</a>
          <a href="/Sarek/preview/pr-78/docs/getting_started.html">Getting Started</a>
          <a href="/Sarek/preview/pr-78/benchmarks/">Benchmarks</a>
          <a href="/Sarek/preview/pr-78/examples/">Examples</a>
          <div class="nav-dropdown">
            <a href="#" class="dropdown-toggle">Docs â–¾</a>
            <div class="dropdown-menu">
              <a href="/Sarek/preview/pr-78/docs/concepts.html">Concepts</a>
              <a href="/Sarek/preview/pr-78/docs/architecture.html">Architecture</a>
              <a href="/Sarek/preview/pr-78/docs/backends.html">Backends</a>
              <a href="/Sarek/preview/pr-78/docs/build_guide.html">Build Guide</a>
              <a href="/Sarek/preview/pr-78/docs/faq.html">FAQ</a>
              <a href="/Sarek/preview/pr-78/docs/publications.html">Publications</a>
            </div>
          </div>
          <a href="/Sarek/preview/pr-78/spoc_docs/index.html">API</a>
          <a href="https://github.com/mathiasbourgoin/Sarek">GitHub</a>
          <button id="theme-toggle" title="Toggle Dark/Light Mode">
            <span>ðŸŒ™</span>
          </button>
        </div>
      </div>
    </nav>

    <main class="main-content">
      <div class="container">
        <h1 id="technical-inspector">Technical Inspector</h1>

<p>See exactly how Sarek translates your high-level OCaml kernels into native GPU code across all major backends.</p>

<h2 id="vector-addition">Vector Addition</h2>

<div class="code-tabs">
  <div class="tab-headers">
    <div class="tab-header active">OCaml (Sarek)</div>
    <div class="tab-header">CUDA</div>
    <div class="tab-header">OpenCL</div>
    <div class="tab-header">Vulkan (GLSL)</div>
    <div class="tab-header">Metal (MSL)</div>
  </div>
  
  <div class="tab-content active">

    <div class="language-ocaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span><span class="o">%</span><span class="n">kernel</span> <span class="n">vector_add</span> <span class="p">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">float32</span> <span class="n">vector</span><span class="p">)</span> <span class="p">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">float32</span> <span class="n">vector</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">float32</span> <span class="n">vector</span><span class="p">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">get_global_id</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="n">c</span><span class="o">.</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">a</span><span class="o">.</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</code></pre></div>    </div>
  </div>
  
  <div class="tab-content">

    <div class="language-cuda highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Auto-generated by Sarek CUDA Backend</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="k">__global__</span> <span class="kt">void</span> <span class="nf">vector_add</span><span class="p">(</span>
    <span class="kt">float</span><span class="o">*</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sarek_a_len</span><span class="p">,</span>
    <span class="kt">float</span><span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sarek_b_len</span><span class="p">,</span>
    <span class="kt">float</span><span class="o">*</span> <span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sarek_c_len</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">sarek_a_len</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">c</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </div>

  <div class="tab-content">

    <pre><code class="language-opencl">// Auto-generated by Sarek OpenCL Backend
__kernel void vector_add(
    __global float* a, int sarek_a_len,
    __global float* b, int sarek_b_len,
    __global float* c, int sarek_c_len
) {
    int idx = get_global_id(0);
    if (idx &lt; sarek_a_len) {
        c[idx] = a[idx] + b[idx];
    }
}
</code></pre>
  </div>

  <div class="tab-content">

    <div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Auto-generated by Sarek Vulkan Backend</span>
<span class="cp">#version 450
</span><span class="k">layout</span><span class="p">(</span><span class="n">local_size_x</span> <span class="o">=</span> <span class="mi">256</span><span class="p">)</span> <span class="k">in</span><span class="p">;</span>
<span class="k">layout</span><span class="p">(</span><span class="n">std430</span><span class="p">,</span> <span class="n">binding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">buffer</span> <span class="n">buf_a</span> <span class="p">{</span> <span class="kt">float</span> <span class="n">a</span><span class="p">[];</span> <span class="p">};</span>
<span class="k">layout</span><span class="p">(</span><span class="n">std430</span><span class="p">,</span> <span class="n">binding</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="n">buffer</span> <span class="n">buf_b</span> <span class="p">{</span> <span class="kt">float</span> <span class="n">b</span><span class="p">[];</span> <span class="p">};</span>
<span class="k">layout</span><span class="p">(</span><span class="n">std430</span><span class="p">,</span> <span class="n">binding</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="n">buffer</span> <span class="n">buf_c</span> <span class="p">{</span> <span class="kt">float</span> <span class="n">c</span><span class="p">[];</span> <span class="p">};</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">gl_GlobalInvocationID</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">c</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </div>

  <div class="tab-content">

    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Auto-generated by Sarek Metal Backend</span>
<span class="cp">#include</span> <span class="cpf">&lt;metal_stdlib&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">metal</span><span class="p">;</span>

<span class="n">kernel</span> <span class="kt">void</span> <span class="nf">vector_add</span><span class="p">(</span>
    <span class="n">device</span> <span class="kt">float</span><span class="o">*</span> <span class="n">a</span> <span class="p">[[</span><span class="n">buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">)]],</span>
    <span class="n">device</span> <span class="kt">float</span><span class="o">*</span> <span class="n">b</span> <span class="p">[[</span><span class="n">buffer</span><span class="p">(</span><span class="mi">1</span><span class="p">)]],</span>
    <span class="n">device</span> <span class="kt">float</span><span class="o">*</span> <span class="n">c</span> <span class="p">[[</span><span class="n">buffer</span><span class="p">(</span><span class="mi">2</span><span class="p">)]],</span>
    <span class="n">uint</span> <span class="n">idx</span> <span class="p">[[</span><span class="n">thread_position_in_grid</span><span class="p">]]</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="n">c</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </div>
</div>

<h2 id="shared-memory-reduction">Shared Memory Reduction</h2>

<div class="code-tabs">
  <div class="tab-headers">
    <div class="tab-header active">OCaml (Sarek)</div>
    <div class="tab-header">CUDA</div>
    <div class="tab-header">OpenCL</div>
    <div class="tab-header">Vulkan (GLSL)</div>
    <div class="tab-header">Metal (MSL)</div>
  </div>
  
  <div class="tab-content active">

    <div class="language-ocaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span><span class="o">%</span><span class="n">kernel</span> <span class="n">reduce</span> <span class="p">(</span><span class="n">input</span> <span class="o">:</span> <span class="n">float32</span> <span class="n">vector</span><span class="p">)</span> <span class="p">(</span><span class="n">output</span> <span class="o">:</span> <span class="n">float32</span> <span class="n">vector</span><span class="p">)</span> <span class="o">=</span>
  <span class="k">let</span><span class="o">%</span><span class="n">shared</span> <span class="n">sdata</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">create</span> <span class="nc">Float32</span> <span class="mi">256</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">thread_idx_x</span> <span class="k">in</span>
  
  <span class="k">let</span><span class="o">%</span><span class="n">superstep</span> <span class="n">load</span> <span class="o">=</span>
    <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">input</span><span class="o">.</span><span class="p">(</span><span class="n">get_global_id</span> <span class="mi">0</span><span class="p">)</span>
  <span class="k">in</span>
  
  <span class="c">(* Logic simplified for display *)</span>
  <span class="k">if</span> <span class="n">tid</span> <span class="o">&lt;</span> <span class="mi">128</span> <span class="k">then</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">+</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span> <span class="o">+</span> <span class="mi">128</span><span class="p">);</span>
  <span class="n">barrier</span> <span class="bp">()</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">output</span><span class="o">.</span><span class="p">(</span><span class="n">block_idx_x</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>    </div>
  </div>
  
  <div class="tab-content">

    <div class="language-cuda highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">extern</span> <span class="s">"C"</span> <span class="k">__global__</span> <span class="kt">void</span> <span class="nf">reduce</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span> <span class="n">input</span><span class="p">,</span> <span class="kt">float</span><span class="o">*</span> <span class="n">output</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">__shared__</span> <span class="kt">float</span> <span class="n">sdata</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

    <span class="n">sdata</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">input</span><span class="p">[</span><span class="n">gid</span><span class="p">];</span>
    <span class="n">__syncthreads</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sdata</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdata</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">+</span> <span class="n">sdata</span><span class="p">[</span><span class="n">tid</span> <span class="o">+</span> <span class="mi">128</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">__syncthreads</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">output</span><span class="p">[</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </div>

  <div class="tab-content">

    <pre><code class="language-opencl">__kernel void reduce(__global float* input, __global float* output) {
    __local float sdata[256];
    int tid = get_local_id(0);
    int gid = get_global_id(0);

    sdata[tid] = input[gid];
    barrier(CLK_LOCAL_MEM_FENCE);

    if (tid &lt; 128) {
        sdata[tid] = sdata[tid] + sdata[tid + 128];
    }
    barrier(CLK_LOCAL_MEM_FENCE);

    if (tid == 0) {
        output[get_group_id(0)] = sdata[0];
    }
}
</code></pre>
  </div>

  <div class="tab-content">

    <div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#version 450
</span><span class="k">layout</span><span class="p">(</span><span class="n">local_size_x</span> <span class="o">=</span> <span class="mi">256</span><span class="p">)</span> <span class="k">in</span><span class="p">;</span>
<span class="k">layout</span><span class="p">(</span><span class="n">std430</span><span class="p">,</span> <span class="n">binding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">buffer</span> <span class="n">b_in</span> <span class="p">{</span> <span class="kt">float</span> <span class="n">input_data</span><span class="p">[];</span> <span class="p">};</span>
<span class="k">layout</span><span class="p">(</span><span class="n">std430</span><span class="p">,</span> <span class="n">binding</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="n">buffer</span> <span class="n">b_out</span> <span class="p">{</span> <span class="kt">float</span> <span class="n">output_data</span><span class="p">[];</span> <span class="p">};</span>
<span class="n">shared</span> <span class="kt">float</span> <span class="n">sdata</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">gl_LocalInvocationID</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="kt">uint</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">gl_GlobalInvocationID</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">sdata</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="n">gid</span><span class="p">];</span>
    <span class="n">barrier</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="n">sdata</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sdata</span><span class="p">[</span><span class="n">tid</span> <span class="o">+</span> <span class="mi">128</span><span class="p">];</span>
    <span class="n">barrier</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">output_data</span><span class="p">[</span><span class="n">gl_WorkGroupID</span><span class="p">.</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </div>

  <div class="tab-content">

    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kernel</span> <span class="kt">void</span> <span class="nf">reduce</span><span class="p">(</span>
    <span class="n">device</span> <span class="kt">float</span><span class="o">*</span> <span class="n">input</span> <span class="p">[[</span><span class="n">buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">)]],</span>
    <span class="n">device</span> <span class="kt">float</span><span class="o">*</span> <span class="n">output</span> <span class="p">[[</span><span class="n">buffer</span><span class="p">(</span><span class="mi">1</span><span class="p">)]],</span>
    <span class="n">threadgroup</span> <span class="kt">float</span><span class="o">*</span> <span class="n">sdata</span> <span class="p">[[</span><span class="n">threadgroup</span><span class="p">(</span><span class="mi">0</span><span class="p">)]],</span>
    <span class="n">uint</span> <span class="n">tid</span> <span class="p">[[</span><span class="n">thread_index_in_threadgroup</span><span class="p">]],</span>
    <span class="n">uint</span> <span class="n">gid</span> <span class="p">[[</span><span class="n">thread_position_in_grid</span><span class="p">]],</span>
    <span class="n">uint</span> <span class="n">bid</span> <span class="p">[[</span><span class="n">threadgroup_position_in_grid</span><span class="p">]]</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="n">sdata</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">input</span><span class="p">[</span><span class="n">gid</span><span class="p">];</span>
    <span class="n">threadgroup_barrier</span><span class="p">(</span><span class="n">mem_flags</span><span class="o">::</span><span class="n">mem_threadgroup</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sdata</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdata</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">+</span> <span class="n">sdata</span><span class="p">[</span><span class="n">tid</span> <span class="o">+</span> <span class="mi">128</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">threadgroup_barrier</span><span class="p">(</span><span class="n">mem_flags</span><span class="o">::</span><span class="n">mem_threadgroup</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">output</span><span class="p">[</span><span class="n">bid</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </div>
</div>

<h2 id="key-takeaways">Key Takeaways</h2>
<ul>
  <li><strong>No Overhead</strong>: Sarek doesnâ€™t add OCaml runtime logic to your kernels. The generated code is identical to what a human would write in C.</li>
  <li><strong>Type Safety</strong>: Sarek handles the complex mapping of OCaml records to C structs and ensures array accesses are handled correctly.</li>
  <li><strong>Unified Logic</strong>: You write the math once; Sarek handles the backend-specific boilerplate (<code class="language-plaintext highlighter-rouge">__global__</code>, <code class="language-plaintext highlighter-rouge">__kernel</code>, <code class="language-plaintext highlighter-rouge">get_global_id</code>, etc.).</li>
</ul>

      </div>
    </main>

    <footer>
      <div class="container">
        <p>Sarek is maintained by <a href="https://github.com/mathiasbourgoin">mathiasbourgoin</a></p>
        <p>Hosted on GitHub Pages</p>
      </div>
    </footer>

    <script src="/Sarek/preview/pr-78/javascripts/scale.fix.js"></script>
    <script src="/Sarek/preview/pr-78/javascripts/copy-code.js"></script>
    <script src="/Sarek/preview/pr-78/javascripts/theme-toggle.js"></script>
    <script src="/Sarek/preview/pr-78/javascripts/syntax-sarek.js"></script>
  </body>
</html>
