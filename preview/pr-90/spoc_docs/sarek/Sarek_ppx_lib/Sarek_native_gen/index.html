<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Sarek_native_gen (sarek.Sarek_ppx_lib.Sarek_native_gen)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">sarek</a> &#x00BB; <a href="../index.html">Sarek_ppx_lib</a> &#x00BB; Sarek_native_gen</nav><header class="odoc-preamble"><h1>Module <code><span>Sarek_ppx_lib.Sarek_native_gen</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#expression-generation">Expression Generation</a></li><li><a href="#first-class-module-name-helpers">First-Class Module Name Helpers</a></li><li><a href="#module-item-generation">Module Item Generation</a></li><li><a href="#type-declaration-generation">Type Declaration Generation</a></li><li><a href="#first-class-module-approach-for-inline-types">First-Class Module Approach for Inline Types</a></li><li><a href="#kernel-generation">Kernel Generation</a></li></ul></nav></div><div class="odoc-content"><h2 id="expression-generation"><a href="#expression-generation" class="anchor"></a>Expression Generation</h2><div class="odoc-spec"><div class="spec module anchored" id="module-IntSet"><a href="#module-IntSet" class="anchor"></a><code><span><span class="keyword">module</span> <a href="IntSet/index.html">IntSet</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Mutable variable tracking. We track which variable IDs are mutable so that TEVar can dereference them.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-StringSet"><a href="#module-StringSet" class="anchor"></a><code><span><span class="keyword">module</span> <a href="StringSet/index.html">StringSet</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Set of inline type names for first-class module approach</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-gen_context"><a href="#type-gen_context" class="anchor"></a><code><span><span class="keyword">type</span> gen_context</span><span> = </span><span>{</span></code><ol><li id="type-gen_context.mut_vars" class="def record field anchored"><a href="#type-gen_context.mut_vars" class="anchor"></a><code><span>mut_vars : <a href="IntSet/index.html#type-t">IntSet.t</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Variable IDs that are mutable (need dereferencing)</p><span class="comment-delim">*)</span></div></li><li id="type-gen_context.inline_types" class="def record field anchored"><a href="#type-gen_context.inline_types" class="anchor"></a><code><span>inline_types : <a href="StringSet/index.html#type-t">StringSet.t</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Type names that use first-class module accessors</p><span class="comment-delim">*)</span></div></li><li id="type-gen_context.current_module" class="def record field anchored"><a href="#type-gen_context.current_module" class="anchor"></a><code><span>current_module : <span>string option</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Current module name for same-module type detection</p><span class="comment-delim">*)</span></div></li><li id="type-gen_context.gen_mode" class="def record field anchored"><a href="#type-gen_context.gen_mode" class="anchor"></a><code><span>gen_mode : <a href="../Sarek_native_intrinsics/index.html#type-gen_mode">Sarek_native_intrinsics.gen_mode</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Generation mode - affects how thread indices are accessed</p><span class="comment-delim">*)</span></div></li><li id="type-gen_context.use_native_arg" class="def record field anchored"><a href="#type-gen_context.use_native_arg" class="anchor"></a><code><span>use_native_arg : bool;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>When true, vector params are accessor objects (v#get i, v#set i x) instead of Vector.t (Vector.get v i, Vector.kernel_set v i x)</p><span class="comment-delim">*)</span></div></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Expression generation context</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-empty_ctx"><a href="#val-empty_ctx" class="anchor"></a><code><span><span class="keyword">val</span> empty_ctx : <a href="#type-gen_context">gen_context</a></span></code></div><div class="spec-doc"><p>Empty generation context</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_same_module"><a href="#val-is_same_module" class="anchor"></a><code><span><span class="keyword">val</span> is_same_module : <span><a href="#type-gen_context">gen_context</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Check if a qualified type name is from the current module. For &quot;Test_registered_variant.color&quot;, returns true if current_module is &quot;Test_registered_variant&quot;.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-types_module_var"><a href="#val-types_module_var" class="anchor"></a><code><span><span class="keyword">val</span> types_module_var : string</span></code></div><div class="spec-doc"><p>The name of the first-class module variable</p></div></div><h2 id="first-class-module-name-helpers"><a href="#first-class-module-name-helpers" class="anchor"></a>First-Class Module Name Helpers</h2><div class="odoc-spec"><div class="spec value anchored" id="val-field_getter_name"><a href="#val-field_getter_name" class="anchor"></a><code><span><span class="keyword">val</span> field_getter_name : <span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Generate accessor function name for a field getter</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-record_maker_name"><a href="#val-record_maker_name" class="anchor"></a><code><span><span class="keyword">val</span> record_maker_name : <span>string <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Generate constructor function name for a record</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-variant_ctor_name"><a href="#val-variant_ctor_name" class="anchor"></a><code><span><span class="keyword">val</span> variant_ctor_name : <span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Generate constructor function name for a variant constructor</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_literal"><a href="#val-gen_literal" class="anchor"></a><code><span><span class="keyword">val</span> gen_literal : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_variable"><a href="#val-gen_variable" class="anchor"></a><code><span><span class="keyword">val</span> gen_variable : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib__</span>.Location.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ctx</span>:<a href="#type-gen_context">gen_context</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span>int <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Generate variable reference (local, module-level, qualified)</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_memory_access"><a href="#val-gen_memory_access" class="anchor"></a><code><span><span class="keyword">val</span> gen_memory_access : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ctx</span>:<a href="#type-gen_context">gen_context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">gen_expr</span>:
    <span>(<span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span> <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Ppxlib_ast</span>.Ast.expression)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Generate memory access operations (vectors, arrays, record fields)</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_let_binding"><a href="#val-gen_let_binding" class="anchor"></a><code><span><span class="keyword">val</span> gen_let_binding : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib__</span>.Location.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ctx</span>:<a href="#type-gen_context">gen_context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">gen_expr</span>:
    <span>(<span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib__</span>.Location.t <span class="arrow">&#45;&gt;</span></span>
      <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span>
      <span class="xref-unresolved">Ppxlib_ast</span>.Ast.expression)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">gen_expr_impl</span>:
    <span>(<span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib__</span>.Location.t <span class="arrow">&#45;&gt;</span></span>
      <span><span class="label">ctx</span>:<a href="#type-gen_context">gen_context</a> <span class="arrow">&#45;&gt;</span></span>
      <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span>
      <span class="xref-unresolved">Ppxlib_ast</span>.Ast.expression)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Generate let bindings (let, let mut, assignment)</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_control_flow"><a href="#val-gen_control_flow" class="anchor"></a><code><span><span class="keyword">val</span> gen_control_flow : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">gen_expr</span>:
    <span>(<span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span> <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Ppxlib_ast</span>.Ast.expression)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Generate control flow (if, for, while)</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_data_structure"><a href="#val-gen_data_structure" class="anchor"></a><code><span><span class="keyword">val</span> gen_data_structure : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ctx</span>:<a href="#type-gen_context">gen_context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">gen_expr</span>:
    <span>(<span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span>
      <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span>
      <span class="xref-unresolved">Ppxlib__</span>.Import.expression)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Generate data structures (records, variants, tuples, arrays)</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_special_expr"><a href="#val-gen_special_expr" class="anchor"></a><code><span><span class="keyword">val</span> gen_special_expr : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib__</span>.Location.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">gen_expr</span>:
    <span>(<span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib__</span>.Location.t <span class="arrow">&#45;&gt;</span></span> <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Ppxlib</span>.expression)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Generate special expressions (return, global ref, native, pragma, open)</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_parallel_construct"><a href="#val-gen_parallel_construct" class="anchor"></a><code><span><span class="keyword">val</span> gen_parallel_construct : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">gen_expr</span>:
    <span>(<span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span> <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Ppxlib_ast</span>.Ast.expression)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Generate BSP parallel constructs (let%shared, let%superstep, let rec)</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_expr_impl"><a href="#val-gen_expr_impl" class="anchor"></a><code><span><span class="keyword">val</span> gen_expr_impl : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib__</span>.Location.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ctx</span>:<a href="#type-gen_context">gen_context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib_ast</span>.Ast.expression</span></code></div><div class="spec-doc"><p>Generate OCaml expression from typed Sarek expression.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">ctx</span> <p>Generation context with mutable vars and inline types</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_pattern_impl"><a href="#val-gen_pattern_impl" class="anchor"></a><code><span><span class="keyword">val</span> gen_pattern_impl : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ctx</span>:<a href="#type-gen_context">gen_context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-tpattern">Sarek_typed_ast.tpattern</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.pattern</span></code></div><div class="spec-doc"><p>Generate pattern from typed pattern. Takes context to detect same-module types that shouldn't be qualified.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_binop"><a href="#val-gen_binop" class="anchor"></a><code><span><span class="keyword">val</span> gen_binop : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_ast/index.html#type-binop">Sarek_ast.binop</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Ppxlib</span>.expression <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Ppxlib</span>.expression <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_types/index.html#type-typ">Sarek_types.typ</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Generate binary operation</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_unop"><a href="#val-gen_unop" class="anchor"></a><code><span><span class="keyword">val</span> gen_unop : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_ast/index.html#type-unop">Sarek_ast.unop</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Ppxlib</span>.expression <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_types/index.html#type-typ">Sarek_types.typ</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Generate unary operation</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-module_name_of_sarek_loc"><a href="#val-module_name_of_sarek_loc" class="anchor"></a><code><span><span class="keyword">val</span> module_name_of_sarek_loc : <span><a href="../Sarek_ast/index.html#type-loc">Sarek_ast.loc</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Extract module name from a Sarek location (file path). For &quot;/path/to/test_registered_variant.ml&quot;, returns &quot;Test_registered_variant&quot;.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_expr"><a href="#val-gen_expr" class="anchor"></a><code><span><span class="keyword">val</span> gen_expr : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib__</span>.Location.t <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Top-level entry point for generating expressions. Starts with empty context.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_expr_with_inline_types"><a href="#val-gen_expr_with_inline_types" class="anchor"></a><code><span><span class="keyword">val</span> gen_expr_with_inline_types : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib__</span>.Location.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">inline_type_names</span>:<a href="StringSet/index.html#type-t">StringSet.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">current_module</span>:<span>string option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Generate expression with inline types context for first-class modules.</p></div></div><h2 id="module-item-generation"><a href="#module-item-generation" class="anchor"></a>Module Item Generation</h2><div class="odoc-spec"><div class="spec value anchored" id="val-gen_module_fun"><a href="#val-gen_module_fun" class="anchor"></a><code><span><span class="keyword">val</span> gen_module_fun : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib__</span>.Location.t <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Sarek_typed_ast/index.html#type-tparam">Sarek_typed_ast.tparam</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.pattern * <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Generate a module-level function (TMFun) as a let binding.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_module_const"><a href="#val-gen_module_const" class="anchor"></a><code><span><span class="keyword">val</span> gen_module_const : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib__</span>.Location.t <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span>int <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_types/index.html#type-typ">Sarek_types.typ</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.pattern * <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Generate a module-level constant (TMConst) as a let binding.</p></div></div><h2 id="type-declaration-generation"><a href="#type-declaration-generation" class="anchor"></a>Type Declaration Generation</h2><div class="odoc-spec"><div class="spec value anchored" id="val-gen_type_decl_record"><a href="#val-gen_type_decl_record" class="anchor"></a><code><span><span class="keyword">val</span> gen_type_decl_record : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(string * <a href="../Sarek_types/index.html#type-typ">Sarek_types.typ</a> * bool)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.structure_item</span></code></div><div class="spec-doc"><p>Generate a type declaration for a record type</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_type_decl_variant"><a href="#val-gen_type_decl_variant" class="anchor"></a><code><span><span class="keyword">val</span> gen_type_decl_variant : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(string * <span><a href="../Sarek_types/index.html#type-typ">Sarek_types.typ</a> option</span>)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.structure_item</span></code></div><div class="spec-doc"><p>Generate a type declaration for a variant type</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_type_decl_item"><a href="#val-gen_type_decl_item" class="anchor"></a><code><span><span class="keyword">val</span> gen_type_decl_item : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-ttype_decl">Sarek_typed_ast.ttype_decl</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.structure_item</span></code></div><div class="spec-doc"><p>Generate a structure item from a typed type declaration</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wrap_module_items"><a href="#val-wrap_module_items" class="anchor"></a><code><span><span class="keyword">val</span> wrap_module_items : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib__</span>.Location.t <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Sarek_typed_ast/index.html#type-tmodule_item">Sarek_typed_ast.tmodule_item</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Ppxlib</span>.expression <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Wrap expression with module item bindings.</p></div></div><h2 id="first-class-module-approach-for-inline-types"><a href="#first-class-module-approach-for-inline-types" class="anchor"></a>First-Class Module Approach for Inline Types</h2><p>To avoid &quot;type escapes its scope&quot; errors, we use first-class modules to encapsulate inline types. The approach:</p><p>1. Generate a module signature KERNEL_TYPES with abstract types and accessors 2. Generate a concrete module implementation with the actual types 3. Transform the kernel body to use T.get_field and T.make_type accessors 4. Pass (module T : KERNEL_TYPES) as a parameter to the kernel</p><p>This keeps the concrete types hidden behind an existential type.</p><div class="odoc-spec"><div class="spec value anchored" id="val-gen_module_impl"><a href="#val-gen_module_impl" class="anchor"></a><code><span><span class="keyword">val</span> gen_module_impl : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Sarek_typed_ast/index.html#type-ttype_decl">Sarek_typed_ast.ttype_decl</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.module_expr</span></code></div><div class="spec-doc"><p>Generate a concrete module implementation for inline types (types only). Example for record type point with fields x and y: struct type point = record with fields x: float and y: float end</p><p>Note: We only generate type declarations here, not accessor functions. The accessor functions are generated as object methods by gen_types_object.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-inline_type_decls"><a href="#val-inline_type_decls" class="anchor"></a><code><span><span class="keyword">val</span> inline_type_decls : 
  <span><span><a href="../Sarek_typed_ast/index.html#type-ttype_decl">Sarek_typed_ast.ttype_decl</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-ttype_decl">Sarek_typed_ast.ttype_decl</a> list</span></span></code></div><div class="spec-doc"><p>Get only inline type declarations (those without module prefix). External/registered types have qualified names like &quot;Module.type&quot;.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-has_inline_types"><a href="#val-has_inline_types" class="anchor"></a><code><span><span class="keyword">val</span> has_inline_types : <span><a href="../Sarek_typed_ast/index.html#type-tkernel">Sarek_typed_ast.tkernel</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Check if a kernel has inline types that need first-class module handling</p></div></div><h2 id="kernel-generation"><a href="#kernel-generation" class="anchor"></a>Kernel Generation</h2><div class="odoc-spec"><div class="spec value anchored" id="val-gen_mode_of_exec_strategy"><a href="#val-gen_mode_of_exec_strategy" class="anchor"></a><code><span><span class="keyword">val</span> gen_mode_of_exec_strategy : 
  <span><a href="../Sarek_convergence/index.html#type-exec_strategy">Sarek_convergence.exec_strategy</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../Sarek_native_intrinsics/index.html#type-gen_mode">Sarek_native_intrinsics.gen_mode</a></span></code></div><div class="spec-doc"><p>Convert execution strategy to generation mode</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_arg_cast"><a href="#val-gen_arg_cast" class="anchor"></a><code><span><span class="keyword">val</span> gen_arg_cast : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-tparam">Sarek_typed_ast.tparam</a> <span class="arrow">&#45;&gt;</span></span>
  <span>int <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Generate a type cast expression for extracting a kernel argument.</p><p>For vectors: extract NA_Vec and create an accessor wrapper. For scalars: match on NA_Int32/NA_Float32/etc and extract the value.</p><p>Uses typed native_arg for type safety.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_types_object"><a href="#val-gen_types_object" class="anchor"></a><code><span><span class="keyword">val</span> gen_types_object : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Sarek_typed_ast/index.html#type-ttype_decl">Sarek_typed_ast.ttype_decl</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Generate an object expression with accessor methods for FCM. Example for type point with fields x and y: object method get_point_x r = r.x method get_point_y r = r.y method make_point ~x ~y = record with fields x and y end</p><p>Using an object avoids needing to define a record type for the accessors.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_cpu_kern_native"><a href="#val-gen_cpu_kern_native" class="anchor"></a><code><span><span class="keyword">val</span> gen_cpu_kern_native : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib__</span>.Location.t <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-tkernel">Sarek_typed_ast.tkernel</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Generate V2 cpu_kern - uses Spoc_core.Vector.get/set instead of Spoc.Mem.</p><p>Generated signature: thread_state -&gt; shared_mem -&gt; args_tuple -&gt; unit This matches the signature expected by run_parallel/run_sequential.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_simple_cpu_kern_native"><a href="#val-gen_simple_cpu_kern_native" class="anchor"></a><code><span><span class="keyword">val</span> gen_simple_cpu_kern_native : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib__</span>.Location.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">exec_strategy</span>:<a href="../Sarek_convergence/index.html#type-exec_strategy">Sarek_convergence.exec_strategy</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-tkernel">Sarek_typed_ast.tkernel</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Generate simple kernel for optimized threadpool execution using the modern vector path (Spoc_core.Vector).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_cpu_kern_native_wrapper"><a href="#val-gen_cpu_kern_native_wrapper" class="anchor"></a><code><span><span class="keyword">val</span> gen_cpu_kern_native_wrapper : 
  <span><span class="label">loc</span>:<span class="xref-unresolved">Ppxlib__</span>.Location.t <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-tkernel">Sarek_typed_ast.tkernel</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p>Generate the cpu_kern wrapper for use with native_fn_t.</p><p>Generated function type: parallel:bool -&gt; block:int*int*int -&gt; grid:int*int*int -&gt; native_arg array -&gt; unit</p><p>Uses typed native_arg accessors for type-safe vector access. Vectors are wrapped in accessor objects with get/set/length/underlying.</p></div></div></div></body></html>
