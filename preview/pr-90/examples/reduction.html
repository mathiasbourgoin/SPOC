<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link rel="icon" href="/Sarek/preview/pr-90/favicon.ico" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
    <script src="/Sarek/preview/pr-90/javascripts/process-rel-links.js" type="text/javascript"></script>
    <title>Parallel Reduction Example - Sarek</title>
    
    <link rel="stylesheet" href='/Sarek/preview/pr-90/stylesheets/modern.css'>
    <link rel="stylesheet" href='/Sarek/preview/pr-90/stylesheets/pygment_trac.css'>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  </head>
  <body>

    <!-- Top Navigation Bar -->
    <nav class="navbar">
      <div class="container">
        <a href="/Sarek/preview/pr-90/" class="nav-brand">
          <img src="/Sarek/preview/pr-90/pres_resources/logo_sarek.png" alt="Sarek Logo">
          Sarek
        </a>
        <div class="nav-links">
          <a href="/Sarek/preview/pr-90/">Home</a>
          <a href="/Sarek/preview/pr-90/docs/getting_started.html">Getting Started</a>
          <a href="/Sarek/preview/pr-90/benchmarks/">Benchmarks</a>
          <a href="/Sarek/preview/pr-90/examples/">Examples</a>
          <div class="nav-dropdown">
            <a href="#" class="dropdown-toggle">Docs â–¾</a>
            <div class="dropdown-menu">
              <a href="/Sarek/preview/pr-90/docs/concepts.html">Concepts</a>
              <a href="/Sarek/preview/pr-90/docs/architecture.html">Architecture</a>
              <a href="/Sarek/preview/pr-90/docs/backends.html">Backends</a>
              <a href="/Sarek/preview/pr-90/docs/build_guide.html">Build Guide</a>
              <a href="/Sarek/preview/pr-90/docs/faq.html">FAQ</a>
              <a href="/Sarek/preview/pr-90/docs/publications.html">Publications</a>
            </div>
          </div>
          <a href="/Sarek/preview/pr-90/spoc_docs/index.html">API</a>
          <a href="https://github.com/mathiasbourgoin/Sarek">GitHub</a>
          <button id="theme-toggle" title="Toggle Dark/Light Mode">
            <span>ðŸŒ™</span>
          </button>
        </div>
      </div>
    </nav>

    <main class="main-content">
      <div class="container">
        <h1 id="parallel-reduction">Parallel Reduction</h1>

<p>Parallel reduction (e.g., sum, max, min) is a common pattern that requires coordination between threads. This example implements a tree-based reduction sum using shared memory.</p>

<h2 id="kernel-code">Kernel Code</h2>

<p>Each thread block reduces a portion of the array into a single value. These partial sums are stored in the output array. A second kernel launch (or CPU loop) is usually required to sum the block results.</p>

<div class="language-ocaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">open</span> <span class="nc">Sarek</span>

<span class="k">let</span> <span class="n">reduce_sum_kernel</span> <span class="o">=</span>
  <span class="p">[</span><span class="o">%</span><span class="n">kernel</span>
    <span class="k">fun</span> <span class="p">(</span><span class="n">input</span> <span class="o">:</span> <span class="n">float32</span> <span class="n">vector</span><span class="p">)</span> <span class="p">(</span><span class="n">output</span> <span class="o">:</span> <span class="n">float32</span> <span class="n">vector</span><span class="p">)</span> <span class="p">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">int32</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="c">(* Shared memory for the block - 256 elements *)</span>
      <span class="k">let</span><span class="o">%</span><span class="n">shared</span> <span class="p">(</span><span class="n">sdata</span> <span class="o">:</span> <span class="n">float32</span><span class="p">)</span> <span class="o">=</span> <span class="mi">256</span><span class="n">l</span> <span class="k">in</span>
      
      <span class="k">let</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">thread_idx_x</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">thread_idx_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">block_dim_x</span> <span class="o">*</span> <span class="n">block_idx_x</span><span class="p">)</span> <span class="k">in</span>
      
      <span class="c">(* Load data: each thread loads one element *)</span>
      <span class="k">let</span><span class="o">%</span><span class="n">superstep</span> <span class="n">load</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">gid</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="k">then</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">input</span><span class="o">.</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span> 
        <span class="k">else</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span>
      <span class="k">in</span>
      
      <span class="c">(* Tree reduction in shared memory - unrolled for efficiency *)</span>
      <span class="k">let</span><span class="o">%</span><span class="n">superstep</span> <span class="n">reduce128</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">tid</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="n">l</span> <span class="k">then</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">+.</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span> <span class="o">+</span> <span class="mi">128</span><span class="n">l</span><span class="p">)</span>
      <span class="k">in</span>
      <span class="k">let</span><span class="o">%</span><span class="n">superstep</span> <span class="n">reduce64</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">tid</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="n">l</span> <span class="k">then</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">+.</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span> <span class="o">+</span> <span class="mi">64</span><span class="n">l</span><span class="p">)</span>
      <span class="k">in</span>
      <span class="k">let</span><span class="o">%</span><span class="n">superstep</span> <span class="n">reduce32</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">tid</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="n">l</span> <span class="k">then</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">+.</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span> <span class="o">+</span> <span class="mi">32</span><span class="n">l</span><span class="p">)</span>
      <span class="k">in</span>
      <span class="k">let</span><span class="o">%</span><span class="n">superstep</span> <span class="n">reduce16</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">tid</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="n">l</span> <span class="k">then</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">+.</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span> <span class="o">+</span> <span class="mi">16</span><span class="n">l</span><span class="p">)</span>
      <span class="k">in</span>
      <span class="k">let</span><span class="o">%</span><span class="n">superstep</span> <span class="n">reduce8</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">tid</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="n">l</span> <span class="k">then</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">+.</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span> <span class="o">+</span> <span class="mi">8</span><span class="n">l</span><span class="p">)</span>
      <span class="k">in</span>
      <span class="k">let</span><span class="o">%</span><span class="n">superstep</span> <span class="n">reduce4</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">tid</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="n">l</span> <span class="k">then</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">+.</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span> <span class="o">+</span> <span class="mi">4</span><span class="n">l</span><span class="p">)</span>
      <span class="k">in</span>
      <span class="k">let</span><span class="o">%</span><span class="n">superstep</span> <span class="n">reduce2</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">tid</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="n">l</span> <span class="k">then</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">+.</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span> <span class="o">+</span> <span class="mi">2</span><span class="n">l</span><span class="p">)</span>
      <span class="k">in</span>
      <span class="k">let</span><span class="o">%</span><span class="n">superstep</span> <span class="n">reduce1</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">tid</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="n">l</span> <span class="k">then</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">+.</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="n">tid</span> <span class="o">+</span> <span class="mi">1</span><span class="n">l</span><span class="p">)</span>
      <span class="k">in</span>
      
      <span class="c">(* Write result for this block *)</span>
      <span class="k">if</span> <span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span><span class="n">l</span> <span class="k">then</span> <span class="n">output</span><span class="o">.</span><span class="p">(</span><span class="n">block_idx_x</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">sdata</span><span class="o">.</span><span class="p">(</span><span class="mi">0</span><span class="n">l</span><span class="p">)]</span>
</code></pre></div></div>

<h2 id="host-code">Host Code</h2>

<div class="language-ocaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">open</span> <span class="nc">Sarek</span>
<span class="k">module</span> <span class="nc">Device</span> <span class="o">=</span> <span class="nn">Spoc_core</span><span class="p">.</span><span class="nc">Device</span>
<span class="k">module</span> <span class="nc">Vector</span> <span class="o">=</span> <span class="nn">Spoc_core</span><span class="p">.</span><span class="nc">Vector</span>

<span class="k">let</span> <span class="n">run_reduction</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">1_000_000</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">256</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">num_blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">block_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">block_size</span> <span class="k">in</span>
  
  <span class="c">(* Compile kernel to IR *)</span>
  <span class="k">let</span> <span class="n">ir</span> <span class="o">=</span> <span class="nn">Sarek</span><span class="p">.</span><span class="nn">Compile</span><span class="p">.</span><span class="n">kernel</span> <span class="n">reduce_sum_kernel</span> <span class="k">in</span>
  
  <span class="c">(* Create input and output vectors *)</span>
  <span class="k">let</span> <span class="n">input</span> <span class="o">=</span> <span class="nn">Vector</span><span class="p">.</span><span class="n">create</span> <span class="nn">Vector</span><span class="p">.</span><span class="n">float32</span> <span class="n">n</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="nn">Vector</span><span class="p">.</span><span class="n">create</span> <span class="nn">Vector</span><span class="p">.</span><span class="n">float32</span> <span class="n">num_blocks</span> <span class="k">in</span>
  
  <span class="c">(* Initialize input data *)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
    <span class="nn">Vector</span><span class="p">.</span><span class="n">set</span> <span class="n">input</span> <span class="n">i</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">;</span>
  <span class="k">done</span><span class="p">;</span>
  
  <span class="c">(* Calculate grid dimensions *)</span>
  <span class="k">let</span> <span class="n">block</span> <span class="o">=</span> <span class="nn">Execute</span><span class="p">.</span><span class="n">dims1d</span> <span class="n">block_size</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">grid</span> <span class="o">=</span> <span class="nn">Execute</span><span class="p">.</span><span class="n">dims1d</span> <span class="n">num_blocks</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">device</span> <span class="o">=</span> <span class="nn">Device</span><span class="p">.</span><span class="n">get_default</span> <span class="bp">()</span> <span class="k">in</span>
  
  <span class="c">(* First pass: Reduce array to num_blocks partial sums *)</span>
  <span class="nn">Execute</span><span class="p">.</span><span class="n">run_vectors</span>
    <span class="o">~</span><span class="n">device</span>
    <span class="o">~</span><span class="n">ir</span>
    <span class="o">~</span><span class="n">args</span><span class="o">:</span><span class="p">[</span><span class="nc">Vec</span> <span class="n">input</span><span class="p">;</span> <span class="nc">Vec</span> <span class="n">output</span><span class="p">;</span> <span class="nc">Int</span> <span class="n">n</span><span class="p">]</span>
    <span class="o">~</span><span class="n">block</span>
    <span class="o">~</span><span class="n">grid</span>
    <span class="bp">()</span><span class="p">;</span>
  
  <span class="c">(* Second pass: Sum the partial results on CPU *)</span>
  <span class="k">let</span> <span class="n">partial_sums</span> <span class="o">=</span> <span class="nn">Vector</span><span class="p">.</span><span class="n">to_array</span> <span class="n">output</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">final_sum</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">fold_left</span> <span class="p">(</span><span class="o">+.</span><span class="p">)</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="n">partial_sums</span> <span class="k">in</span>
  
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">"Sum of %d elements: %f</span><span class="se">\n</span><span class="s2">"</span> <span class="n">n</span> <span class="n">final_sum</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~block:(256, 1, 1)
~grid:(num_blocks, 1, 1)
[Vec input; Vec output; Int32 n];
</code></pre></div></div>

<p>(* Second pass: Sum the partial results (on CPU for simplicity here) *)
  let partials = Vector.to_array output in
  let total = Array.fold_left (+.) 0.0 partials
```</p>

      </div>
    </main>

    <footer>
      <div class="container">
        <p>Sarek is maintained by <a href="https://github.com/mathiasbourgoin">mathiasbourgoin</a></p>
        <p>Hosted on GitHub Pages</p>
      </div>
    </footer>

    <script src="/Sarek/preview/pr-90/javascripts/scale.fix.js"></script>
    <script src="/Sarek/preview/pr-90/javascripts/copy-code.js"></script>
    <script src="/Sarek/preview/pr-90/javascripts/theme-toggle.js"></script>
    <script src="/Sarek/preview/pr-90/javascripts/syntax-sarek.js"></script>
  </body>
</html>
