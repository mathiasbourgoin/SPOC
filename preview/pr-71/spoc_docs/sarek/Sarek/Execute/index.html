<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Execute (sarek.Sarek.Execute)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">sarek</a> &#x00BB; <a href="../index.html">Sarek</a> &#x00BB; Execute</nav><header class="odoc-preamble"><h1>Module <code><span>Sarek.Execute</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#v2-vector-argument-type">V2 Vector Argument Type</a></li><li><a href="#execution-dispatch">Execution Dispatch</a></li><li><a href="#v2-vector-execution-helpers">V2 Vector Execution Helpers</a></li><li><a href="#convenience-functions">Convenience Functions</a></li><li><a href="#external-kernel-execution">External Kernel Execution</a></li></ul></nav></div><div class="odoc-content"><h2 id="v2-vector-argument-type"><a href="#v2-vector-argument-type" class="anchor"></a>V2 Vector Argument Type</h2><p>Re-export structured error types</p><div class="odoc-spec"><div class="spec type anchored" id="type-vector_arg"><a href="#type-vector_arg" class="anchor"></a><code><span><span class="keyword">type</span> vector_arg</span><span> = </span></code><ol><li id="type-vector_arg.Vec" class="def variant constructor anchored"><a href="#type-vector_arg.Vec" class="anchor"></a><code><span>| </span><span><span class="constructor">Vec</span> : <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>)</span> <a href="../../Spoc_core/Vector/index.html#type-t">Spoc_core.Vector.t</a></span> <span class="arrow">&#45;&gt;</span> <a href="#type-vector_arg">vector_arg</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>V2 Vector - expands to (buffer, length) for JIT</p><span class="comment-delim">*)</span></div></li><li id="type-vector_arg.Int" class="def variant constructor anchored"><a href="#type-vector_arg.Int" class="anchor"></a><code><span>| </span><span><span class="constructor">Int</span> : int <span class="arrow">&#45;&gt;</span> <a href="#type-vector_arg">vector_arg</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Integer scalar</p><span class="comment-delim">*)</span></div></li><li id="type-vector_arg.Int32" class="def variant constructor anchored"><a href="#type-vector_arg.Int32" class="anchor"></a><code><span>| </span><span><span class="constructor">Int32</span> : int32 <span class="arrow">&#45;&gt;</span> <a href="#type-vector_arg">vector_arg</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>32-bit integer scalar</p><span class="comment-delim">*)</span></div></li><li id="type-vector_arg.Int64" class="def variant constructor anchored"><a href="#type-vector_arg.Int64" class="anchor"></a><code><span>| </span><span><span class="constructor">Int64</span> : int64 <span class="arrow">&#45;&gt;</span> <a href="#type-vector_arg">vector_arg</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>64-bit integer scalar</p><span class="comment-delim">*)</span></div></li><li id="type-vector_arg.Float32" class="def variant constructor anchored"><a href="#type-vector_arg.Float32" class="anchor"></a><code><span>| </span><span><span class="constructor">Float32</span> : float <span class="arrow">&#45;&gt;</span> <a href="#type-vector_arg">vector_arg</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>32-bit float scalar</p><span class="comment-delim">*)</span></div></li><li id="type-vector_arg.Float64" class="def variant constructor anchored"><a href="#type-vector_arg.Float64" class="anchor"></a><code><span>| </span><span><span class="constructor">Float64</span> : float <span class="arrow">&#45;&gt;</span> <a href="#type-vector_arg">vector_arg</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>64-bit float scalar</p><span class="comment-delim">*)</span></div></li></ol></div><div class="spec-doc"><p>V2 Vector argument type - supports automatic transfers and length expansion. This is the main type-safe way to pass arguments to kernels.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-vector_args_to_exec_array"><a href="#val-vector_args_to_exec_array" class="anchor"></a><code><span><span class="keyword">val</span> vector_args_to_exec_array : 
  <span><span><a href="#type-vector_arg">vector_arg</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-exec_arg">Spoc_framework.Framework_sig.exec_arg</a> array</span></span></code></div><div class="spec-doc"><p>Convert vector_arg list to exec_arg array (new typed interface). Creates EXEC_VECTOR wrappers for vectors.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_device_buffer"><a href="#val-get_device_buffer" class="anchor"></a><code><span><span class="keyword">val</span> get_device_buffer : 
  <span><span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>)</span> <a href="../../Spoc_core/Vector/index.html#type-t">Spoc_core.Vector.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Spoc_core/Device/index.html#type-t">Spoc_core.Device.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>(<span class="keyword">module</span> <a href="../../Spoc_core/Memory/module-type-BUFFER/index.html">Spoc_core.Vector.DEVICE_BUFFER</a>)</span></span></code></div><div class="spec-doc"><p>Retrieve device buffer for a vector on a specific device.</p><p>Returns a first-class module containing the device buffer's pointer, size, and binding function. The buffer must exist (typically created by a prior transfer).</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">v</span> <p>Vector to get buffer from</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">dev</span> <p>Device the buffer should be allocated on</p></li></ul><ul class="at-tags"><li class="returns"><span class="at-tag">returns</span> <p>Device buffer module</p></li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Transfer_failed</code> <p>if vector has no buffer on this device</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-transfer_vectors_to_device"><a href="#val-transfer_vectors_to_device" class="anchor"></a><code><span><span class="keyword">val</span> transfer_vectors_to_device : <span><span><a href="#type-vector_arg">vector_arg</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../Spoc_core/Device/index.html#type-t">Spoc_core.Device.t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Transfer all V2 Vector args to device</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-expand_to_run_source_args"><a href="#val-expand_to_run_source_args" class="anchor"></a><code><span><span class="keyword">val</span> expand_to_run_source_args : 
  <span><span class="optlabel">?inject_lengths</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-vector_arg">vector_arg</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Spoc_core/Device/index.html#type-t">Spoc_core.Device.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-run_source_arg">Spoc_framework.Framework_sig.run_source_arg</a> list</span></span></code></div><div class="spec-doc"><p>Expand vector args to run_source_arg format.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">inject_lengths</span> <p>If true (default), auto-inject vector length as Int32 after each buffer. This matches Sarek-generated kernels which expect (ptr, len) pairs. Set to false for external kernels with different signatures.</p></li></ul></div></div><h2 id="execution-dispatch"><a href="#execution-dispatch" class="anchor"></a>Execution Dispatch</h2><div class="odoc-spec"><div class="spec value anchored" id="val-run"><a href="#val-run" class="anchor"></a><code><span><span class="keyword">val</span> run : 
  <span><span class="label">device</span>:<a href="../../Spoc_core/Device/index.html#type-t">Spoc_core.Device.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ir</span>:<span><span><a href="../../../spoc/Sarek_ir_types/index.html#type-kernel">Sarek_ir_types.kernel</a> <span class="xref-unresolved">Stdlib</span>.Lazy.t</span> option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">native_fn</span>:
    <span><span>(<span><span class="label">block</span>:<a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-dims">Spoc_framework.Framework_sig.dims</a> <span class="arrow">&#45;&gt;</span></span>
      <span><span class="label">grid</span>:<a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-dims">Spoc_framework.Framework_sig.dims</a> <span class="arrow">&#45;&gt;</span></span>
      <span><span><a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-exec_arg">Spoc_framework.Framework_sig.exec_arg</a> array</span> <span class="arrow">&#45;&gt;</span></span>
      unit)</span>
      option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">block</span>:<a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-dims">Spoc_framework.Framework_sig.dims</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">grid</span>:<a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-dims">Spoc_framework.Framework_sig.dims</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?shared_mem</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-vector_arg">vector_arg</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>Execute a kernel on a device using the unified dispatch mechanism.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">device</span> <p>Target device</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">name</span> <p>Kernel name</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">ir</span> <p>Sarek IR kernel (lazy, only forced for JIT backends)</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">native_fn</span> <p>Pre-compiled native function (for Direct backends)</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">block</span> <p>Block dimensions</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">grid</span> <p>Grid dimensions</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">shared_mem</span> <p>Shared memory size in bytes (default 0)</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">args</span> <p>Kernel arguments as vector_arg list</p></li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Execution_error</code> <p>if execution fails</p></li></ul></div></div><h2 id="v2-vector-execution-helpers"><a href="#v2-vector-execution-helpers" class="anchor"></a>V2 Vector Execution Helpers</h2><div class="odoc-spec"><div class="spec value anchored" id="val-mark_vectors_stale"><a href="#val-mark_vectors_stale" class="anchor"></a><code><span><span class="keyword">val</span> mark_vectors_stale : <span><span><a href="#type-vector_arg">vector_arg</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../Spoc_core/Device/index.html#type-t">Spoc_core.Device.t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Mark vectors as stale on CPU after kernel execution.</p><p>After a kernel modifies vector data on a device, we need to track that the CPU-side data is now stale. This ensures future CPU reads will trigger a device→CPU transfer.</p><p>Special cases:</p><ul><li>Native backend: No-op (uses zero-copy shared memory, no staleness)</li><li>JIT backends: Always mark stale (Transfer module handles zero-copy checks)</li><li>OpenCL CPU: Mark stale for custom types (scalar types use zero-copy)</li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">args</span> <p>Arguments that may contain vectors</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">dev</span> <p>Device that just executed the kernel</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-vector_to_interp_array"><a href="#val-vector_to_interp_array" class="anchor"></a><code><span><span class="keyword">val</span> vector_to_interp_array : 
  'a 'b. <span><span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>)</span> <a href="../../Spoc_core/Vector/index.html#type-t">Spoc_core.Vector.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_ir_interp/index.html#type-value">Sarek_ir_interp.value</a> array</span></span></code></div><div class="spec-doc"><p>Convert a V2 Vector to interpreter value array.</p><p>Converts vectors of primitive types (int32, float32, etc.) to the interpreter's runtime value representation. Custom types are converted using registered type helpers from Sarek_type_helpers.</p><p>This enables the interpreter backend to execute kernels on CPU without requiring GPU infrastructure.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">vec</span> <p>Input vector of any type</p></li></ul><ul class="at-tags"><li class="returns"><span class="at-tag">returns</span> <p>Array of interpreter values matching vector contents</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-interp_array_to_vector"><a href="#val-interp_array_to_vector" class="anchor"></a><code><span><span class="keyword">val</span> interp_array_to_vector : 
  'a 'b. <span><span><a href="../Sarek_ir_interp/index.html#type-value">Sarek_ir_interp.value</a> array</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>)</span> <a href="../../Spoc_core/Vector/index.html#type-t">Spoc_core.Vector.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>Copy interpreter value array back to V2 Vector.</p><p>After interpreter execution, this function copies the runtime values back into the typed vector representation. Performs type checking and conversion for each element.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">arr</span> <p>Array of interpreter runtime values</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">vec</span> <p>Destination vector (must match type of values)</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-run_interpreter_vectors"><a href="#val-run_interpreter_vectors" class="anchor"></a><code><span><span class="keyword">val</span> run_interpreter_vectors : 
  <span><span class="label">ir</span>:<a href="../../../spoc/Sarek_ir_types/index.html#type-kernel">Sarek_ir_types.kernel</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">args</span>:<span><a href="#type-vector_arg">vector_arg</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">block</span>:<a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-dims">Spoc_framework.Framework_sig.dims</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">grid</span>:<a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-dims">Spoc_framework.Framework_sig.dims</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">parallel</span>:bool <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>Run kernel via interpreter with V2 Vectors. Note: Interpreter works with IR params directly - one arg per param. Vectors map to ArgArray (length is intrinsic to array).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-run_vectors"><a href="#val-run_vectors" class="anchor"></a><code><span><span class="keyword">val</span> run_vectors : 
  <span><span class="label">device</span>:<a href="../../Spoc_core/Device/index.html#type-t">Spoc_core.Device.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ir</span>:<a href="../../../spoc/Sarek_ir_types/index.html#type-kernel">Sarek_ir_types.kernel</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">args</span>:<span><a href="#type-vector_arg">vector_arg</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">block</span>:<a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-dims">Spoc_framework.Framework_sig.dims</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">grid</span>:<a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-dims">Spoc_framework.Framework_sig.dims</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?shared_mem</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>Execute a kernel with V2 Vectors. Auto-transfers, dispatches to backend.</p><p>This is the main execution entry point for Sarek-generated kernels. It performs the complete execution pipeline:</p><p>1. **Transfer**: Move vectors to device (no-op for CPU backends) 2. **Dispatch**: Call appropriate backend's execution method 3. **Mark stale**: Update vector location tracking</p><p>The function automatically handles differences between execution models:</p><ul><li>JIT backends: Generate source, compile, launch</li><li>Direct (Native): Call pre-compiled OCaml function</li><li>Custom (Interpreter): Walk IR and evaluate expressions</li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">device</span> <p>Target device (determines backend)</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">ir</span> <p>Sarek IR kernel definition</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">args</span> <p>Kernel arguments (vectors and scalars)</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">block</span> <p>Thread block dimensions (e.g., (256, 1, 1))</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">grid</span> <p>Grid dimensions (e.g., (4, 1, 1))</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">shared_mem</span> <p>Optional shared memory size in bytes (default: 0)</p></li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <a href="../Execute_error/index.html"><code>Execute_error</code></a> <p>on validation or execution failure</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-sync_vectors_to_cpu"><a href="#val-sync_vectors_to_cpu" class="anchor"></a><code><span><span class="keyword">val</span> sync_vectors_to_cpu : <span><span><a href="#type-vector_arg">vector_arg</a> list</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Sync all V2 Vector outputs back to CPU</p></div></div><h2 id="convenience-functions"><a href="#convenience-functions" class="anchor"></a>Convenience Functions</h2><div class="odoc-spec"><div class="spec value anchored" id="val-dims1d"><a href="#val-dims1d" class="anchor"></a><code><span><span class="keyword">val</span> dims1d : <span>int <span class="arrow">&#45;&gt;</span></span> <a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-dims">Spoc_framework.Framework_sig.dims</a></span></code></div><div class="spec-doc"><p>Create 1D grid and block dimensions</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-dims2d"><a href="#val-dims2d" class="anchor"></a><code><span><span class="keyword">val</span> dims2d : <span>int <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-dims">Spoc_framework.Framework_sig.dims</a></span></code></div><div class="spec-doc"><p>Create 2D grid and block dimensions</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-dims3d"><a href="#val-dims3d" class="anchor"></a><code><span><span class="keyword">val</span> dims3d : <span>int <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-dims">Spoc_framework.Framework_sig.dims</a></span></code></div><div class="spec-doc"><p>Create 3D grid and block dimensions</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-grid_for_size"><a href="#val-grid_for_size" class="anchor"></a><code><span><span class="keyword">val</span> grid_for_size : <span><span class="label">problem_size</span>:int <span class="arrow">&#45;&gt;</span></span> <span><span class="label">block_size</span>:int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Calculate grid size for a given problem size and block size</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-grid_for"><a href="#val-grid_for" class="anchor"></a><code><span><span class="keyword">val</span> grid_for : 
  <span><span class="label">problem_size</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">block_size</span>:int <span class="arrow">&#45;&gt;</span></span>
  <a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-dims">Spoc_framework.Framework_sig.dims</a></span></code></div><div class="spec-doc"><p>Calculate 1D grid dimensions for a problem size</p></div></div><h2 id="external-kernel-execution"><a href="#external-kernel-execution" class="anchor"></a>External Kernel Execution</h2><div class="odoc-spec"><div class="spec type anchored" id="type-source_lang"><a href="#type-source_lang" class="anchor"></a><code><span><span class="keyword">type</span> source_lang</span><span> = <a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-source_lang">Spoc_framework.Framework_sig.source_lang</a></span><span> = </span></code><ol><li id="type-source_lang.CUDA_Source" class="def variant constructor anchored"><a href="#type-source_lang.CUDA_Source" class="anchor"></a><code><span>| </span><span><span class="constructor">CUDA_Source</span></span></code></li><li id="type-source_lang.OpenCL_Source" class="def variant constructor anchored"><a href="#type-source_lang.OpenCL_Source" class="anchor"></a><code><span>| </span><span><span class="constructor">OpenCL_Source</span></span></code></li><li id="type-source_lang.PTX" class="def variant constructor anchored"><a href="#type-source_lang.PTX" class="anchor"></a><code><span>| </span><span><span class="constructor">PTX</span></span></code></li><li id="type-source_lang.SPIR_V" class="def variant constructor anchored"><a href="#type-source_lang.SPIR_V" class="anchor"></a><code><span>| </span><span><span class="constructor">SPIR_V</span></span></code></li><li id="type-source_lang.GLSL_Source" class="def variant constructor anchored"><a href="#type-source_lang.GLSL_Source" class="anchor"></a><code><span>| </span><span><span class="constructor">GLSL_Source</span></span></code></li></ol></div><div class="spec-doc"><p>Re-export source language type</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-supports_lang"><a href="#val-supports_lang" class="anchor"></a><code><span><span class="keyword">val</span> supports_lang : <span><a href="../../Spoc_core/Device/index.html#type-t">Spoc_core.Device.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-source_lang">source_lang</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Check if a device supports a given source language.</p><p>Different backends support different source languages:</p><ul><li>CUDA: CUDA source (.cu), PTX</li><li>OpenCL: OpenCL source (.cl)</li><li>Vulkan: SPIR-V, GLSL source (.comp, .glsl)</li><li>Native/Interpreter: None (not JIT backends)</li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">dev</span> <p>Device to check</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">lang</span> <p>Source language to query</p></li></ul><ul class="at-tags"><li class="returns"><span class="at-tag">returns</span> <p>true if device can compile and execute this language</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-run_source"><a href="#val-run_source" class="anchor"></a><code><span><span class="keyword">val</span> run_source : 
  <span><span class="label">device</span>:<a href="../../Spoc_core/Device/index.html#type-t">Spoc_core.Device.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">source</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">lang</span>:<a href="#type-source_lang">source_lang</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">kernel_name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">block</span>:<a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-dims">Spoc_framework.Framework_sig.dims</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">grid</span>:<a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-dims">Spoc_framework.Framework_sig.dims</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?shared_mem</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?inject_lengths</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-vector_arg">vector_arg</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>Execute an external kernel from source code.</p><p>This function allows running pre-written GPU kernels (CUDA, OpenCL, PTX) directly without going through the Sarek DSL.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">device</span> <p>Target device</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">source</span> <p>Kernel source code as string</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">lang</span> <p>Source language (CUDA_Source, OpenCL_Source, PTX)</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">kernel_name</span> <p>Name of the kernel function in the source</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">block</span> <p>Block dimensions</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">grid</span> <p>Grid dimensions</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">shared_mem</span> <p>Shared memory size in bytes (default 0)</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">inject_lengths</span> <p>If true (default), auto-inject vector length as Int32 after each buffer argument. Sarek-generated kernels expect (ptr, len) pairs. Set to false for external kernels that don't follow this convention.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">args</span> <p>Kernel arguments as vector_arg list</p></li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Execution_error</code> <p>if device doesn't support the source language</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-load_source"><a href="#val-load_source" class="anchor"></a><code><span><span class="keyword">val</span> load_source : <span>string <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Load kernel source from a file</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-detect_lang"><a href="#val-detect_lang" class="anchor"></a><code><span><span class="keyword">val</span> detect_lang : <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-source_lang">source_lang</a></span></code></div><div class="spec-doc"><p>Detect source language from file extension</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-run_source_file"><a href="#val-run_source_file" class="anchor"></a><code><span><span class="keyword">val</span> run_source_file : 
  <span><span class="label">device</span>:<a href="../../Spoc_core/Device/index.html#type-t">Spoc_core.Device.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">path</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">kernel_name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">block</span>:<a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-dims">Spoc_framework.Framework_sig.dims</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">grid</span>:<a href="../../../spoc/Spoc_framework/Framework_sig/index.html#type-dims">Spoc_framework.Framework_sig.dims</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?shared_mem</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?inject_lengths</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-vector_arg">vector_arg</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>Execute an external kernel from a file.</p><p>Loads pre-written GPU kernel source from a file and executes it. Useful for integrating hand-optimized kernels or using features not yet supported by the Sarek PPX.</p><p>Source language is auto-detected from file extension:</p><ul><li>.cu → CUDA source</li><li>.cl → OpenCL source</li><li>.ptx → PTX assembly</li><li>.spv → SPIR-V binary</li><li>.comp / .glsl → GLSL compute shader</li></ul><p>Example:</p><pre class="language-ocaml"><code>  (* Execute hand-written CUDA kernel *)
  Execute.run_source_file
    ~device:(Device.get_default ())
    ~path:&quot;kernels/optimized_matmul.cu&quot;
    ~kernel_name:&quot;matmul_kernel&quot;
    ~block:(16, 16, 1)
    ~grid:(64, 64, 1)
    [Vec a; Vec b; Vec c; Int32 1024l]</code></pre><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">device</span> <p>Target device</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">path</span> <p>Path to kernel source file</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">kernel_name</span> <p>Name of kernel function in source</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">block</span> <p>Block dimensions</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">grid</span> <p>Grid dimensions</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">shared_mem</span> <p>Optional shared memory in bytes</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">inject_lengths</span> <p>If true (default), inject vector lengths after buffer args</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">args</span> <p>Kernel arguments</p></li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_file</code> <p>if file extension is not recognized</p></li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <a href="../Execute_error/index.html"><code>Execute_error</code></a> <p>if compilation or execution fails</p></li></ul></div></div></div></body></html>
