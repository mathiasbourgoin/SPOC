<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Sarek_convergence (sarek.Sarek_ppx_lib.Sarek_convergence)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">sarek</a> &#x00BB; <a href="../index.html">Sarek_ppx_lib</a> &#x00BB; Sarek_convergence</nav><header class="odoc-preamble"><h1>Module <code><span>Sarek_ppx_lib.Sarek_convergence</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#kernel-dimensionality-analysis">Kernel Dimensionality Analysis</a></li></ul></nav></div><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-exec_mode"><a href="#type-exec_mode" class="anchor"></a><code><span><span class="keyword">type</span> exec_mode</span><span> = </span></code><ol><li id="type-exec_mode.Converged" class="def variant constructor anchored"><a href="#type-exec_mode.Converged" class="anchor"></a><code><span>| </span><span><span class="constructor">Converged</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>All threads in workgroup execute this code</p><span class="comment-delim">*)</span></div></li><li id="type-exec_mode.Diverged" class="def variant constructor anchored"><a href="#type-exec_mode.Diverged" class="anchor"></a><code><span>| </span><span><span class="constructor">Diverged</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Threads may have taken different branches</p><span class="comment-delim">*)</span></div></li></ol></div><div class="spec-doc"><p>Execution mode for convergence analysis</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-ctx"><a href="#type-ctx" class="anchor"></a><code><span><span class="keyword">type</span> ctx</span><span> = </span><span>{</span></code><ol><li id="type-ctx.mode" class="def record field anchored"><a href="#type-ctx.mode" class="anchor"></a><code><span>mode : <a href="#type-exec_mode">exec_mode</a>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Analysis context</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init_ctx"><a href="#val-init_ctx" class="anchor"></a><code><span><span class="keyword">val</span> init_ctx : <a href="#type-ctx">ctx</a></span></code></div><div class="spec-doc"><p>Initial context - start converged</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-diverge"><a href="#val-diverge" class="anchor"></a><code><span><span class="keyword">val</span> diverge : <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-ctx">ctx</a></span></code></div><div class="spec-doc"><p>Enter diverged mode</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_thread_varying_intrinsic"><a href="#val-is_thread_varying_intrinsic" class="anchor"></a><code><span><span class="keyword">val</span> is_thread_varying_intrinsic : <span><a href="../Sarek_env/index.html#type-intrinsic_ref">Sarek_env.intrinsic_ref</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Check if an intrinsic ref is thread-varying using core primitives</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_barrier_ref"><a href="#val-is_barrier_ref" class="anchor"></a><code><span><span class="keyword">val</span> is_barrier_ref : <span><a href="../Sarek_env/index.html#type-intrinsic_ref">Sarek_env.intrinsic_ref</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Check if an intrinsic ref is a barrier/convergence point</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_thread_varying"><a href="#val-is_thread_varying" class="anchor"></a><code><span><span class="keyword">val</span> is_thread_varying : <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Check if an expression's value varies per-thread.</p><p>Thread-varying (different per thread):</p><ul><li>thread_idx_x, thread_idx_y, thread_idx_z</li><li>global_thread_id</li><li>Expressions derived from above</li><li>Array accesses with thread-varying index</li></ul><p>Uniform (same for all threads in workgroup):</p><ul><li>Constants and literals</li><li>block_idx_x/y/z (same for whole block)</li><li>block_dim_x/y/z, grid_dim_x/y/z</li><li>Expressions derived only from uniform values</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_barrier_intrinsic"><a href="#val-is_barrier_intrinsic" class="anchor"></a><code><span><span class="keyword">val</span> is_barrier_intrinsic : <span><a href="../Sarek_env/index.html#type-intrinsic_ref">Sarek_env.intrinsic_ref</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Check if an intrinsic reference is a barrier</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_warp_convergence_ref"><a href="#val-is_warp_convergence_ref" class="anchor"></a><code><span><span class="keyword">val</span> is_warp_convergence_ref : <span><a href="../Sarek_env/index.html#type-intrinsic_ref">Sarek_env.intrinsic_ref</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Check if an intrinsic ref requires warp convergence</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-check_expr"><a href="#val-check_expr" class="anchor"></a><code><span><span class="keyword">val</span> check_expr : <span><a href="#type-ctx">ctx</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Sarek_error/index.html#type-error">Sarek_error.error</a> list</span></span></code></div><div class="spec-doc"><p>Collect errors from convergence analysis</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-contains_diverging_control_flow"><a href="#val-contains_diverging_control_flow" class="anchor"></a><code><span><span class="keyword">val</span> contains_diverging_control_flow : <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Check if an expression contains any control flow with thread-varying conditions. This is used for superstep analysis - the implicit barrier at the end of a superstep requires that no divergence occurs within the body.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-check_module_item"><a href="#val-check_module_item" class="anchor"></a><code><span><span class="keyword">val</span> check_module_item : 
  <span><a href="#type-ctx">ctx</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_typed_ast/index.html#type-tmodule_item">Sarek_typed_ast.tmodule_item</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sarek_error/index.html#type-error">Sarek_error.error</a> list</span></span></code></div><div class="spec-doc"><p>Check a module item</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-check_kernel"><a href="#val-check_kernel" class="anchor"></a><code><span><span class="keyword">val</span> check_kernel : 
  <span><a href="../Sarek_typed_ast/index.html#type-tkernel">Sarek_typed_ast.tkernel</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(unit, <span><a href="../Sarek_error/index.html#type-error">Sarek_error.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p>Check a kernel for convergence safety</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-expr_uses_barriers"><a href="#val-expr_uses_barriers" class="anchor"></a><code><span><span class="keyword">val</span> expr_uses_barriers : <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Check if a kernel uses any barriers (explicit or implicit). Used for compile-time optimization of native kernel execution.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-kernel_uses_barriers"><a href="#val-kernel_uses_barriers" class="anchor"></a><code><span><span class="keyword">val</span> kernel_uses_barriers : <span><a href="../Sarek_typed_ast/index.html#type-tkernel">Sarek_typed_ast.tkernel</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Check if a kernel uses barriers</p></div></div><h2 id="kernel-dimensionality-analysis"><a href="#kernel-dimensionality-analysis" class="anchor"></a>Kernel Dimensionality Analysis</h2><p>Detect which thread/block dimensions a kernel uses to enable optimized native CPU execution. Simple kernels that only use global_idx_x can be run with a simple parallel for loop without the thread_state overhead.</p><div class="odoc-spec"><div class="spec type anchored" id="type-dim_usage"><a href="#type-dim_usage" class="anchor"></a><code><span><span class="keyword">type</span> dim_usage</span><span> = </span><span>{</span></code><ol><li id="type-dim_usage.uses_x" class="def record field anchored"><a href="#type-dim_usage.uses_x" class="anchor"></a><code><span>uses_x : bool;</span></code></li><li id="type-dim_usage.uses_y" class="def record field anchored"><a href="#type-dim_usage.uses_y" class="anchor"></a><code><span>uses_y : bool;</span></code></li><li id="type-dim_usage.uses_z" class="def record field anchored"><a href="#type-dim_usage.uses_z" class="anchor"></a><code><span>uses_z : bool;</span></code></li><li id="type-dim_usage.uses_block_dim" class="def record field anchored"><a href="#type-dim_usage.uses_block_dim" class="anchor"></a><code><span>uses_block_dim : bool;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Uses block_dim_x/y/z</p><span class="comment-delim">*)</span></div></li><li id="type-dim_usage.uses_grid_dim" class="def record field anchored"><a href="#type-dim_usage.uses_grid_dim" class="anchor"></a><code><span>uses_grid_dim : bool;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Uses grid_dim_x/y/z</p><span class="comment-delim">*)</span></div></li><li id="type-dim_usage.uses_thread_idx" class="def record field anchored"><a href="#type-dim_usage.uses_thread_idx" class="anchor"></a><code><span>uses_thread_idx : bool;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Uses thread_idx_x/y/z directly</p><span class="comment-delim">*)</span></div></li><li id="type-dim_usage.uses_block_idx" class="def record field anchored"><a href="#type-dim_usage.uses_block_idx" class="anchor"></a><code><span>uses_block_idx : bool;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Uses block_idx_x/y/z directly</p><span class="comment-delim">*)</span></div></li><li id="type-dim_usage.uses_shared_mem" class="def record field anchored"><a href="#type-dim_usage.uses_shared_mem" class="anchor"></a><code><span>uses_shared_mem : bool;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Uses shared memory</p><span class="comment-delim">*)</span></div></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Dimension usage record</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-empty_dim_usage"><a href="#val-empty_dim_usage" class="anchor"></a><code><span><span class="keyword">val</span> empty_dim_usage : <a href="#type-dim_usage">dim_usage</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-merge_dim_usage"><a href="#val-merge_dim_usage" class="anchor"></a><code><span><span class="keyword">val</span> merge_dim_usage : <span><a href="#type-dim_usage">dim_usage</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-dim_usage">dim_usage</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-dim_usage">dim_usage</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-dim_usage_of_name"><a href="#val-dim_usage_of_name" class="anchor"></a><code><span><span class="keyword">val</span> dim_usage_of_name : <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-dim_usage">dim_usage</a></span></code></div><div class="spec-doc"><p>Check if an intrinsic name affects dimension usage</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-dim_usage_of_intrinsic_ref"><a href="#val-dim_usage_of_intrinsic_ref" class="anchor"></a><code><span><span class="keyword">val</span> dim_usage_of_intrinsic_ref : <span><a href="../Sarek_env/index.html#type-intrinsic_ref">Sarek_env.intrinsic_ref</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-dim_usage">dim_usage</a></span></code></div><div class="spec-doc"><p>Get dimension usage from an intrinsic reference</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-expr_dim_usage"><a href="#val-expr_dim_usage" class="anchor"></a><code><span><span class="keyword">val</span> expr_dim_usage : <span><a href="../Sarek_typed_ast/index.html#type-texpr">Sarek_typed_ast.texpr</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-dim_usage">dim_usage</a></span></code></div><div class="spec-doc"><p>Analyze expression for dimension usage</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-exec_strategy"><a href="#type-exec_strategy" class="anchor"></a><code><span><span class="keyword">type</span> exec_strategy</span><span> = </span></code><ol><li id="type-exec_strategy.Simple1D" class="def variant constructor anchored"><a href="#type-exec_strategy.Simple1D" class="anchor"></a><code><span>| </span><span><span class="constructor">Simple1D</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Only uses global_idx_x - can use simple parallel for</p><span class="comment-delim">*)</span></div></li><li id="type-exec_strategy.Simple2D" class="def variant constructor anchored"><a href="#type-exec_strategy.Simple2D" class="anchor"></a><code><span>| </span><span><span class="constructor">Simple2D</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Only uses global_idx_x/y - can use nested loops</p><span class="comment-delim">*)</span></div></li><li id="type-exec_strategy.Simple3D" class="def variant constructor anchored"><a href="#type-exec_strategy.Simple3D" class="anchor"></a><code><span>| </span><span><span class="constructor">Simple3D</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Uses all three dimensions with simple loops</p><span class="comment-delim">*)</span></div></li><li id="type-exec_strategy.FullState" class="def variant constructor anchored"><a href="#type-exec_strategy.FullState" class="anchor"></a><code><span>| </span><span><span class="constructor">FullState</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Uses block/thread indices or shared memory - needs full state</p><span class="comment-delim">*)</span></div></li></ol></div><div class="spec-doc"><p>Kernel execution strategy based on dimension analysis</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-kernel_exec_strategy"><a href="#val-kernel_exec_strategy" class="anchor"></a><code><span><span class="keyword">val</span> kernel_exec_strategy : <span><a href="../Sarek_typed_ast/index.html#type-tkernel">Sarek_typed_ast.tkernel</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-exec_strategy">exec_strategy</a></span></code></div><div class="spec-doc"><p>Determine the optimal execution strategy for a kernel</p></div></div></div></body></html>
